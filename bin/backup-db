#!/bin/bash
# Daily database backup script for Sellio
# This script creates a timestamped backup of the PostgreSQL database and storage files

set -e

# Configuration
DB_NAME="sellio"
DB_USER="postgres"
DB_HOST="localhost"
DB_PORT="5432"
DB_PASSWORD="test"
BACKUP_DIR="${HOME}/sellio-backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/sellio_backup_${DATE}.sql"
STORAGE_BACKUP="${BACKUP_DIR}/sellio_storage_${DATE}.tar.gz"
RAILS_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
KEEP_DAYS=30  # Keep backups for 30 days

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

echo -e "${GREEN}Starting database backup...${NC}"
echo "Database: ${DB_NAME}"
echo "Backup file: ${BACKUP_FILE}"

# Create the backup
export PGPASSWORD="${DB_PASSWORD}"
if pg_dump -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USER}" -d "${DB_NAME}" -F p > "${BACKUP_FILE}" 2>&1; then
    # Compress the backup
    gzip "${BACKUP_FILE}"
    BACKUP_FILE="${BACKUP_FILE}.gz"
    
    # Get file size
    SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    
    echo -e "${GREEN}✓ Database backup completed successfully!${NC}"
    echo "  File: ${BACKUP_FILE}"
    echo "  Size: ${SIZE}"
    
    # Backup storage directory
    echo -e "${GREEN}Backing up storage directory...${NC}"
    if [ -d "${RAILS_ROOT}/storage" ]; then
        tar -czf "${STORAGE_BACKUP}" -C "${RAILS_ROOT}" storage/ 2>/dev/null
        if [ $? -eq 0 ]; then
            STORAGE_SIZE=$(du -h "${STORAGE_BACKUP}" | cut -f1)
            echo -e "${GREEN}✓ Storage backup completed!${NC}"
            echo "  File: ${STORAGE_BACKUP}"
            echo "  Size: ${STORAGE_SIZE}"
        else
            echo -e "${YELLOW}⚠ Storage backup failed (directory may be empty)${NC}"
        fi
    else
        echo -e "${YELLOW}⚠ Storage directory not found, skipping...${NC}"
    fi
    
    # Clean up old backups (older than KEEP_DAYS)
    echo -e "${YELLOW}Cleaning up old backups (keeping last ${KEEP_DAYS} days)...${NC}"
    find "${BACKUP_DIR}" -name "sellio_backup_*.sql.gz" -type f -mtime +${KEEP_DAYS} -delete
    find "${BACKUP_DIR}" -name "sellio_storage_*.tar.gz" -type f -mtime +${KEEP_DAYS} -delete
    
    OLD_COUNT=$(find "${BACKUP_DIR}" -name "sellio_backup_*.sql.gz" -type f | wc -l)
    echo -e "${GREEN}✓ Cleanup complete. Total backups: ${OLD_COUNT}${NC}"
    
    exit 0
else
    echo -e "${RED}✗ Backup failed!${NC}"
    exit 1
fi
