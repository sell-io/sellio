<% content_for :title, "Messages - Dealio" %>

<div class="whatsapp-layout">
  <!-- Left Column: Conversations List -->
  <div class="conversations-panel">
    <div class="conversations-header">
      <div class="conversations-header-content">
        <div class="conversations-title">Chats</div>
      </div>
    </div>
    
    <div class="conversations-search">
      <div class="search-box">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="conversation-search" placeholder="Search for a chat" />
      </div>
    </div>
    
    <div class="conversations-list" id="conversations-list">
      <% if @conversations.any? %>
        <% @conversations.each do |key, conversation| %>
          <% 
            other_user = conversation[:other_user]
            last_message = conversation[:last_message]
            is_selected = @selected_message && @selected_message.listing_id == conversation[:listing].id && 
                         (@selected_message.sender == other_user || @selected_message.recipient == other_user)
          %>
          <div class="conversation-item-wrapper #{'active' if is_selected} #{'has-unread' if conversation[:unread_count] > 0}"
               data-search-name="<%= (other_user.name || other_user.email).downcase %>"
               data-search-listing="<%= conversation[:listing] ? conversation[:listing].title.downcase : '' %>"
               data-search-message="<%= last_message.content.downcase %>">
            <%= link_to my_messages_path(message_id: last_message.id), 
                class: "conversation-item" do %>
              <div class="conversation-avatar">
                <% if other_user.avatar.attached? %>
                  <%= image_tag other_user.avatar, alt: other_user.name || other_user.email %>
                <% else %>
                  <div class="avatar-placeholder">
                    <%= (other_user.name || other_user.email).first.upcase %>
                  </div>
                <% end %>
              </div>
              <div class="conversation-info">
                <div class="conversation-header-row">
                  <div class="conversation-name"><%= other_user.name || other_user.email %></div>
                  <div class="conversation-time">
                    <%= last_message.created_at.strftime("%H:%M") %>
                  </div>
                </div>
                <div class="conversation-listing-name">
                  <%= conversation[:listing] ? truncate(conversation[:listing].title, length: 40) : "No listing" %>
                </div>
                <div class="conversation-preview-row">
                  <div class="conversation-preview">
                    <%= truncate(last_message.content, length: 50) %>
                  </div>
                  <% if conversation[:unread_count] > 0 %>
                    <div class="unread-badge"><%= conversation[:unread_count] %></div>
                  <% end %>
                </div>
              </div>
            <% end %>
            <%= button_to delete_conversation_path, 
                method: :delete,
                params: { listing_id: conversation[:listing].id, other_user_id: other_user.id },
                class: "delete-conversation-button",
                title: "Delete conversation",
                data: { confirm: "Are you sure you want to delete this conversation?" } do %>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="empty-conversations">
          <p>No conversations yet</p>
          <p>Start chatting by contacting a seller!</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Right Column: Active Chat -->
  <div class="chat-panel">
    <% if @selected_message && @conversation_messages %>
      <%= render partial: 'chat_view', locals: { 
        message: @selected_message, 
        other_user: @other_user, 
        conversation_messages: @conversation_messages 
      } %>
    <% else %>
      <div class="empty-chat">
        <div class="empty-chat-icon">
          <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        <h2>Select a conversation</h2>
        <p>Choose a chat from the list to start messaging</p>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('conversation-search');
    
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const conversationsList = document.getElementById('conversations-list');
        
        if (!conversationsList) return;
        
        const conversationItems = conversationsList.querySelectorAll('.conversation-item-wrapper');
        
        conversationItems.forEach(function(item) {
          const searchName = (item.getAttribute('data-search-name') || '').toLowerCase();
          const searchListing = (item.getAttribute('data-search-listing') || '').toLowerCase();
          const searchMessage = (item.getAttribute('data-search-message') || '').toLowerCase();
          
          const matches = searchTerm === '' || 
                         searchName.includes(searchTerm) || 
                         searchListing.includes(searchTerm) || 
                         searchMessage.includes(searchTerm);
          
          if (matches) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }
  });
</script>
