<% content_for :title, "Conversation - Dealio" %>

<% 
  # Get all messages in this conversation
  other_user = @message.sender == current_user ? @message.recipient : @message.sender
  @conversation_messages = Message.where(listing_id: @message.listing_id)
                                  .where("(sender_id = ? AND recipient_id = ?) OR (sender_id = ? AND recipient_id = ?)", 
                                         current_user.id, other_user.id, other_user.id, current_user.id)
                                  .includes(:sender, :recipient)
                                  .order(created_at: :asc)
  
  # Mark all messages as read if current user is recipient
  @conversation_messages.where(recipient_id: current_user.id, read: false).update_all(read: true)
  
  # Group messages by date for better organization
  @messages_by_date = @conversation_messages.group_by { |m| m.created_at.to_date }
%>

<div class="chat-shell">
  <!-- Header -->
  <div class="chat-header">
    <div class="left">
      <%= link_to my_messages_path, { class: "chat-back-button", title: "Back to messages", "aria-label" => "Back to messages" } do %>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      <% end %>
      <div class="avatar">
        <% if other_user.avatar.attached? %>
          <%= image_tag other_user.avatar, class: "chat-avatar-image", alt: other_user.name || other_user.email %>
        <% else %>
          <%= (other_user.name || other_user.email).first.upcase %>
        <% end %>
      </div>
      <div>
        <div class="name"><%= other_user.name || other_user.email %></div>
        <div class="subtitle">
          <% if @message.listing %>
            <%= truncate(@message.listing.title, length: 40) %>
          <% else %>
            Online
          <% end %>
        </div>
      </div>
      <% if @message.listing %>
        <%= link_to @message.listing, { class: "chat-listing-link", title: "View listing" } do %>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Messages -->
  <div class="chat-body" id="chat-messages" role="log" aria-live="polite" aria-label="Conversation messages">
    <% @conversation_messages.each do |message| %>
      <% is_sent = message.sender == current_user %>
      
      <div class="message <%= is_sent ? 'outgoing' : 'incoming' %>">
        <div class="bubble">
          <span class="text"><%= h(message.content.to_s.strip) %></span>
          <span class="time"><%= message.created_at.strftime("%H:%M") %></span>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Input -->
  <div class="chat-input">
    <%= form_with(model: [@message.listing, Message.new], url: messages_path, local: true, id: "chat-form") do |form| %>
      <%= form.hidden_field :listing_id, value: @message.listing.id %>
      <%= form.hidden_field :recipient_id, value: other_user.id %>
      <%= form.text_field :content, placeholder: "Type a messageâ€¦", id: "chat-input", required: true, "aria-label" => "Message input" %>
      <%= form.submit "Send", class: "send-button" %>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    
    // Auto-scroll to bottom
    function scrollToBottom() {
      if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Send on Enter
    if (chatInput) {
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (chatForm && chatInput.value.trim()) {
            chatForm.submit();
            chatInput.value = '';
          }
        }
      });
      
      // Focus input on load
      chatInput.focus();
    }
    
    // Scroll to bottom when new messages are added (for future real-time updates)
    const observer = new MutationObserver(function() {
      scrollToBottom();
    });
    
    if (chatMessages) {
      observer.observe(chatMessages, { childList: true, subtree: true });
    }
    
    // Handle form submission
    if (chatForm) {
      chatForm.addEventListener('submit', function(e) {
        if (!chatInput.value.trim()) {
          e.preventDefault();
          return false;
        }
      });
    }
  });
</script>
