<% content_for :title, "Dealo - Buy & Sell Anything" %>

<% if notice %>
  <div class="alert alert-success"><%= notice %></div>
<% end %>

<% is_browse_page = request.path == '/listings' %>

<div class="homepage">
  <!-- Hero Section with Search (only show on homepage, not on browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <% motors_cat = Category.find_by("name ILIKE ?", "%motor%") %>
  <% farming_cat = Category.find_by("name ILIKE ?", "%farming%") %>
  <% marketplace_categories = @categories.reject { |c| c.name.to_s.downcase.include?("motor") || c.name.to_s.downcase.include?("farming") } %>
  <section class="hero-section marketplace-hero" style="background-image: url('/SellioHomePage.png'); background-size: cover; background-position: center; position: relative;">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1 class="hero-title marketplace-hero-title">Buy & Sell Anything</h1>
      <p class="marketplace-hero-subtitle">Free classified ads in your area</p>
      <div class="marketplace-card">
        <div class="marketplace-category-cards" role="group" aria-label="Choose a category">
          <button type="button" class="marketplace-category-card" data-tab="cars" data-category-id="<%= motors_cat&.id %>" aria-pressed="false">
            <span class="marketplace-category-card-icon" aria-hidden="true">üöó</span>
            <span class="marketplace-category-card-label">Cars & Motor</span>
          </button>
          <button type="button" class="marketplace-category-card" data-tab="marketplace" data-category-id="" aria-pressed="false">
            <span class="marketplace-category-card-icon" aria-hidden="true">üõç</span>
            <span class="marketplace-category-card-label">Marketplace</span>
          </button>
          <button type="button" class="marketplace-category-card" data-tab="farming" data-category-id="<%= farming_cat&.id %>" aria-pressed="false">
            <span class="marketplace-category-card-icon" aria-hidden="true">üöú</span>
            <span class="marketplace-category-card-label">Agri & Plant</span>
          </button>
        </div>
        <div class="marketplace-search-wrap" id="marketplaceSearchWrap" hidden>
          <%= form_with url: listings_path, method: :get, local: true, class: "marketplace-search-form" do |f| %>
            <%= f.hidden_field :category_id, value: "", id: "marketplaceSearchCategoryId" %>
            <div class="marketplace-search-row">
              <div class="marketplace-search-input-wrap">
                <span class="marketplace-search-icon" aria-hidden="true">
                  <svg class="marketplace-search-icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                </span>
                <%= f.text_field :search, placeholder: "Search cars and motors", class: "marketplace-search-input", id: "marketplaceSearchInput", data: { placeholder_cars: "Search cars and motors", placeholder_marketplace: "Search marketplace", placeholder_farming: "Search agri & plant" } %>
              </div>
              <%= f.select :location, options_for_select([["All Ireland", ""]] + ApplicationHelper::IRISH_COUNTIES.map { |c| [c, c] }, params[:location]), {}, { class: "marketplace-location-select" } %>
            </div>
            <%= f.submit "Search Cars & Motor", class: "marketplace-search-button", id: "marketplaceSearchButton", data: { label_cars: "Search Cars & Motor", label_marketplace: "Search Marketplace", label_farming: "Search Agri & Plant" } %>
          <% end %>
        </div>
      </div>
    </div>
  </section>
  <section class="marketplace-subcategories-section" id="marketplaceSubcategoriesSection" hidden>
    <div class="marketplace-subcategories-panel" id="panel-cars" data-tab="cars">
      <% if motors_cat %>
        <% motors_category = motors_cat %>
        <div class="car-filter-section car-filter-section--in-panel">
          <div class="container">
            <div class="car-filter-box">
              <h2 class="car-filter-title">Looking for a new car?</h2>
              <%= form_with url: listings_path, method: :get, local: true, class: "car-filter-form" do |f| %>
                <%= f.hidden_field :category_id, value: motors_category.id %>
                <%= f.hidden_field :subcategory, value: "Car" %>
                <div class="car-filter-grid">
                  <div class="car-filter-field">
                    <%= f.label :make, "All Makes" %>
                    <%= f.select :make, options_for_select([
                      ['All Makes', ''],
                      ['Alfa Romeo', 'Alfa Romeo'],
                      ['Aston Martin', 'Aston Martin'],
                      ['Audi', 'Audi'],
                      ['Bentley', 'Bentley'],
                      ['BMW', 'BMW'],
                      ['Chevrolet', 'Chevrolet'],
                      ['Chrysler', 'Chrysler'],
                      ['Citroen', 'Citroen'],
                      ['Dacia', 'Dacia'],
                      ['Dodge', 'Dodge'],
                      ['Ferrari', 'Ferrari'],
                      ['Fiat', 'Fiat'],
                      ['Ford', 'Ford'],
                      ['Honda', 'Honda'],
                      ['Hyundai', 'Hyundai'],
                      ['Infiniti', 'Infiniti'],
                      ['Jaguar', 'Jaguar'],
                      ['Jeep', 'Jeep'],
                      ['Kia', 'Kia'],
                      ['Lamborghini', 'Lamborghini'],
                      ['Land Rover', 'Land Rover'],
                      ['Lexus', 'Lexus'],
                      ['Maserati', 'Maserati'],
                      ['Mazda', 'Mazda'],
                      ['McLaren', 'McLaren'],
                      ['Mercedes-Benz', 'Mercedes-Benz'],
                      ['Mini', 'Mini'],
                      ['Mitsubishi', 'Mitsubishi'],
                      ['Nissan', 'Nissan'],
                      ['Opel', 'Opel'],
                      ['Peugeot', 'Peugeot'],
                      ['Porsche', 'Porsche'],
                      ['Renault', 'Renault'],
                      ['Rolls-Royce', 'Rolls-Royce'],
                      ['Seat', 'Seat'],
                      ['Skoda', 'Skoda'],
                      ['Smart', 'Smart'],
                      ['Subaru', 'Subaru'],
                      ['Suzuki', 'Suzuki'],
                      ['Tesla', 'Tesla'],
                      ['Toyota', 'Toyota'],
                      ['Vauxhall', 'Vauxhall'],
                      ['Volkswagen', 'Volkswagen'],
                      ['Volvo', 'Volvo']
                    ], params[:make]), {}, { class: "car-filter-select", id: "car_make_select" } %>
                  </div>
                  <div class="car-filter-field">
                    <%= f.label :model, "All Models" %>
                    <%= f.select :model, options_for_select([['All Models', '']], params[:model]), {}, { class: "car-filter-select", id: "car_model_select" } %>
                  </div>
                  <div class="car-filter-field">
                    <%= f.label :min_year, "Min Year" %>
                    <%= f.select :min_year, options_for_select([['Min Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:min_year]), {}, { class: "car-filter-select" } %>
                  </div>
                  <div class="car-filter-field">
                    <%= f.label :max_year, "Max Year" %>
                    <%= f.select :max_year, options_for_select([['Max Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:max_year]), {}, { class: "car-filter-select" } %>
                  </div>
                  <div class="car-filter-field">
                    <%= f.label :min_price, "Min Price" %>
                    <%= f.number_field :min_price, placeholder: "Min Price", class: "car-filter-input", min: 0, step: 100, value: params[:min_price] %>
                  </div>
                  <div class="car-filter-field">
                    <%= f.label :max_price, "Max Price" %>
                    <%= f.number_field :max_price, placeholder: "Max Price", class: "car-filter-input", min: 0, step: 100, value: params[:max_price] %>
                  </div>
                </div>
                <div class="form-actions">
                  <% car_count = Listing.where(category_id: motors_category.id).where("extra_fields->>'subcategory' = ?", "Car").count %>
                  <%= f.submit "Search #{number_with_delimiter(car_count)} Cars", class: "car-filter-button" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div class="farming-section-block farming-section-block--motors">
          <div class="container farming-section-inner motors-sections-inner">
            <% motors_sections(motors_cat).each do |section_heading, items| %>
              <% header = motors_section_header(section_heading) %>
              <div class="motors-category-section">
                <div class="motors-section-header">
                  <span class="motors-section-header-icon" aria-hidden="true">
                    <% if header[:emoji].present? %>
                      <span class="motors-section-emoji" aria-hidden="true"><%= header[:emoji] %></span>
                    <% else %>
                      <i data-lucide="<%= header[:icon] %>" class="motors-section-icon" aria-hidden="true"></i>
                    <% end %>
                  </span>
                  <div class="motors-section-header-text">
                    <h3 class="motors-section-title"><%= section_heading %></h3>
                    <% if header[:subtitle].present? %>
                      <p class="motors-section-subtitle"><%= header[:subtitle] %></p>
                    <% end %>
                  </div>
                </div>
                <div class="motors-tiles-grid">
                  <% items.each do |item| %>
                    <%= link_to item[:name], listings_path(category_id: motors_cat.id, subcategory: item[:name]), class: "motors-tile", data: { turbo: false } %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    <div class="marketplace-subcategories-panel" id="panel-marketplace" data-tab="marketplace">
      <div class="farming-section-block farming-section-block--marketplace">
        <div class="container farming-section-inner motors-sections-inner">
          <% header = marketplace_section_header %>
          <div class="motors-category-section">
            <div class="motors-section-header">
              <span class="motors-section-header-icon" aria-hidden="true">
                <% if header[:emoji].present? %>
                  <span class="motors-section-emoji" aria-hidden="true"><%= header[:emoji] %></span>
                <% else %>
                  <i data-lucide="<%= header[:icon] %>" class="motors-section-icon" aria-hidden="true"></i>
                <% end %>
              </span>
              <div class="motors-section-header-text">
                <h3 class="motors-section-title">Marketplace</h3>
                <% if header[:subtitle].present? %>
                  <p class="motors-section-subtitle"><%= header[:subtitle] %></p>
                <% end %>
              </div>
            </div>
            <div class="motors-tiles-grid">
              <% marketplace_cards_items(marketplace_categories).each do |item| %>
                <%= link_to item[:name], listings_path(category_id: item[:id]), class: "motors-tile", data: { turbo: false } %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="marketplace-subcategories-panel farming-panel" id="panel-farming" data-tab="farming">
      <% if farming_cat %>
        <% farming_sections.each do |section_heading, items| %>
          <div class="farming-section-block farming-section-block--<%= farming_section_slug(section_heading) %>">
            <div class="container farming-section-inner motors-sections-inner">
              <% header = farming_section_header(section_heading) %>
              <div class="motors-category-section">
                <div class="motors-section-header">
                  <span class="motors-section-header-icon" aria-hidden="true">
                    <% if header[:emoji].present? %>
                      <span class="motors-section-emoji" aria-hidden="true"><%= header[:emoji] %></span>
                    <% else %>
                      <i data-lucide="<%= header[:icon] %>" class="motors-section-icon" aria-hidden="true"></i>
                    <% end %>
                  </span>
                  <div class="motors-section-header-text">
                    <h3 class="motors-section-title"><%= section_heading %></h3>
                    <% if header[:subtitle].present? %>
                      <p class="motors-section-subtitle"><%= header[:subtitle] %></p>
                    <% end %>
                  </div>
                </div>
                <div class="motors-tiles-grid">
                  <% items.each do |item| %>
                    <%= link_to item[:name], listings_path(category_id: farming_cat.id, subcategory: item[:name]), class: "motors-tile", data: { turbo: false } %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <div class="farming-view-all-block">
          <div class="container">
            <%= link_to "View All Farming", listings_path(category_id: farming_cat.id), class: "farming-view-all-btn", data: { turbo: false } %>
          </div>
        </div>
      <% end %>
    </div>
  </section>
  <script>
    (function() {
      var cards = document.querySelectorAll('.marketplace-category-card');
      var searchWrap = document.getElementById('marketplaceSearchWrap');
      var panels = document.querySelectorAll('.marketplace-subcategories-panel');
      function updateSearchContext(tab, categoryId) {
          var input = document.getElementById('marketplaceSearchInput');
          var btn = document.getElementById('marketplaceSearchButton');
          var catInput = document.getElementById('marketplaceSearchCategoryId');
          if (input && btn) {
            var p = input.getAttribute('data-placeholder-' + tab);
            var l = btn.getAttribute('data-label-' + tab);
            input.placeholder = p || 'Search marketplace';
            btn.value = l || 'Search Marketplace';
          }
          if (catInput) { catInput.value = categoryId || ''; }
        }
      cards.forEach(function(card) {
        card.addEventListener('click', function() {
          var t = this.getAttribute('data-tab');
          var categoryId = this.getAttribute('data-category-id') || '';
          cards.forEach(function(c) { c.classList.remove('active'); c.setAttribute('aria-pressed', 'false'); });
          this.classList.add('active'); this.setAttribute('aria-pressed', 'true');
          if (searchWrap) { searchWrap.hidden = false; }
          updateSearchContext(t, categoryId);
          var section = document.getElementById('marketplaceSubcategoriesSection');
          if (section) { section.hidden = false; }
          var trendingSection = document.getElementById('trendingSearchesSection');
          if (trendingSection) { trendingSection.hidden = true; }
          var categoriesSection = document.getElementById('homeCategoriesSection');
          if (categoriesSection) { categoriesSection.hidden = true; }
          panels.forEach(function(p) {
            if (p.getAttribute('data-tab') === t) { p.classList.add('active'); } else { p.classList.remove('active'); }
          });
          if (typeof lucide !== 'undefined') {
            var root = document.getElementById('panel-cars');
            if (t === 'cars' && root) lucide.createIcons({ root: root });
            else if (t === 'marketplace') { root = document.getElementById('panel-marketplace'); if (root) lucide.createIcons({ root: root }); }
            else if (t === 'farming') { root = document.getElementById('panel-farming'); if (root) lucide.createIcons({ root: root }); }
          }
        });
      });
    })();
  </script>
  <% end %>

  <script>
    // Comprehensive car make-model relationships
    const carModels = {
      'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'TT', 'R8', 'e-tron', 'e-tron GT', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
      'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X4 M', 'X5 M', 'X6 M'],
      'Mercedes-Benz': ['A-Class', 'B-Class', 'C-Class', 'E-Class', 'S-Class', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'SL', 'AMG GT', 'EQC', 'EQS', 'EQE', 'C63 AMG', 'E63 AMG', 'S63 AMG', 'G63 AMG'],
'Volkswagen': ['Golf', 'Polo', 'Passat', 'Jetta', 'Tiguan', 'Touareg', 'Arteon', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.Buzz', 'Beetle', 'Up!', 'Scirocco', 'Sharan', 'Touran', 'Amarok', 'Caddy', 'Fox', 'Lupo', 'Eos', 'CC', 'Phaeton']
'Ford': ['Fiesta', 'Focus', 'Mondeo', 'Kuga', 'Edge', 'Explorer', 'Mustang', 'Puma', 'EcoSport', 'Ranger', 'Transit', 'S-Max', 'Galaxy', 'Tourneo', 'Fusion', 'Escape', 'Expedition', 'F-150', 'Ka', 'C-Max', 'Grand C-Max', 'Bronco', 'Maverick', 'Territory', 'Falcon']
'Toyota': ['Aygo', 'Yaris', 'Corolla', 'Camry', 'Prius', 'C-HR', 'RAV4', 'Highlander', 'Land Cruiser', 'Hilux', 'Proace', 'Avensis', 'Auris', 'Verso', 'GT86', 'Supra', 'bZ4X', 'Vitz', 'Celica', 'MR2', 'Tundra', 'Sequoia', 'Sienna', 'Tacoma', '4Runner', 'Matrix', 'FJ Cruiser']
'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot', 'Fit', 'Jazz', 'Insight', 'Ridgeline', 'Passport', 'Odyssey', 'e', 'CR-Z', 'NSX', 'City', 'S2000', 'Prelude', 'Element', 'Crosstour']
'Hyundai': ['i10', 'i20', 'i30', 'Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Ioniq', 'Palisade', 'Venue', 'Nexo', 'IONIQ 5', 'IONIQ 6', 'Genesis', 'Veloster', 'Accent', 'Azera', 'Equus', 'Veracruz', 'Tiburon', 'XG', 'Grandeur']
'Nissan': ['Micra', 'Sentra', 'Altima', 'Maxima', 'Juke', 'Qashqai', 'X-Trail', 'Pathfinder', 'Armada', 'Leaf', 'Ariya', '370Z', 'GT-R', 'Navara', 'Note', 'Pulsar', 'Almera', 'Primera', '350Z', 'Murano', 'Rogue', 'Frontier', 'Titan', 'Versa', 'Kicks']
'Renault': ['Clio', 'Megane', 'Scenic', 'Kadjar', 'Captur', 'Koleos', 'Talisman', 'Zoe', 'Twingo', 'Kangoo', 'Trafic', 'Master', 'Arkana', 'Austral', 'Laguna', 'Fluence', 'Wind', 'Modus', 'Espace', 'Vel Satis']
'Peugeot': ['108', '208', '308', '508', '2008', '3008', '5008', 'Partner', 'Expert', 'Boxer', 'Rifter', 'Traveller', 'e-208', 'e-2008', '107', '207', '307', '407', '607', '1007', '4007', 'RCZ']
'Citroen': ['C1', 'C3', 'C4', 'C5', 'Berlingo', 'Cactus', 'C4 Picasso', 'Grand C4 Picasso', 'SpaceTourer', 'Jumper', 'e-C4', 'Ami', 'C2', 'C6', 'C8', 'DS3', 'DS4', 'DS5', 'Xantia', 'Xsara', 'C15']
'Skoda': ['Fabia', 'Octavia', 'Superb', 'Kodiaq', 'Karoq', 'Kamiq', 'Scala', 'Enyaq', 'Rapid', 'Yeti', 'Citigo']
'Seat': ['Ibiza', 'Leon', 'Ateca', 'Tarraco', 'Arona', 'Formentor', 'Alhambra', 'Altea', 'Toledo', 'Cupra Born', 'Cupra Formentor', 'Mii', 'Exeo', 'Cordoba']
'Mazda': ['Mazda2', 'Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'CX-30', 'MX-5', 'MX-30', 'BT-50', 'CX-50', 'CX-60', 'CX-70', 'CX-90', 'RX-7', 'RX-8', 'MPV', 'Tribute']
'Kia': ['Picanto', 'Rio', 'Ceed', 'Optima', 'Sportage', 'Sorento', 'Stonic', 'Niro', 'EV6', 'Soul', 'Seltos', 'Telluride', 'Carnival', 'Stinger', 'Ceed SW', 'ProCeed', 'Xceed', 'Mohave', 'Borrego']
'Volvo': ['V40', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'S60', 'S90', 'C30', 'C70', 'XC70', 'EX30', 'EX90', 'S40', 'S80', 'V50', 'V70', 'XC30', '850', '240', '740', '940']
'Opel': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e', 'Vectra', 'Zafira', 'Meriva', 'Tigra', 'Agila', 'Antara', 'Cascada']
'Vauxhall': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e', 'Vectra', 'Zafira', 'Meriva', 'Tigra', 'Agila', 'Antara', 'Cascada']
'Fiat': ['500', 'Panda', 'Punto', 'Tipo', '500X', '500L', 'Doblo', 'Qubo', 'Talento', 'Ducato', '500e', 'Bravo', 'Brava', 'Stilo', 'Multipla', 'Ulysse', 'Sedici', 'Linea', 'Grande Punto']
'Suzuki': ['Swift', 'Vitara', 'S-Cross', 'Jimny', 'Ignis', 'SX4', 'Baleno', 'Celerio', 'Across', 'Splash', 'Kizashi', 'Grand Vitara', 'XL7', 'Samurai']
'Mitsubishi': ['Mirage', 'Lancer', 'Outlander', 'ASX', 'Eclipse Cross', 'Shogun', 'Pajero', 'i-MiEV', 'Colt', 'Galant', 'Eclipse', '3000GT', 'Diamante', 'Montero', 'Space Star']
'Subaru': ['Impreza', 'Legacy', 'Outback', 'Forester', 'XV', 'BRZ', 'Ascent', 'WRX', 'Levorg', 'Tribeca', 'Baja', 'SVX', 'Justy', 'B9 Tribeca']
'Jaguar': ['XE', 'XF', 'XJ', 'F-Pace', 'E-Pace', 'I-Pace', 'F-Type', 'XK', 'X-Type', 'S-Type', 'XFR', 'XKR', 'XJ220']
'Land Rover': ['Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Sport', 'Range Rover Evoque', 'Defender', 'Range Rover Velar', 'Freelander', 'LR2', 'LR3', 'LR4']
'Lexus': ['IS', 'ES', 'GS', 'LS', 'NX', 'RX', 'UX', 'GX', 'LX', 'LC', 'RC', 'CT', 'SC', 'HS', 'LFA']
'Porsche': ['911', '718', 'Panamera', 'Macan', 'Cayenne', 'Taycan', 'Boxster', 'Cayman', '924', '928', '944', '968', '959', 'Carrera GT']
      'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Cybertruck'],
'Mini': ['Hatch', 'Clubman', 'Countryman', 'Convertible', 'Paceman', 'Coupe', 'Roadster', 'One', 'Cooper', 'Cooper S', 'John Cooper Works', 'Electric']
      'Smart': ['Fortwo', 'Forfour', 'EQ Fortwo', 'EQ Forfour'],
      'Dacia': ['Sandero', 'Duster', 'Logan', 'Lodgy', 'Dokker', 'Spring'],
'Chevrolet': ['Spark', 'Cruze', 'Malibu', 'Equinox', 'Tahoe', 'Silverado', 'Traverse', 'Blazer', 'Camaro', 'Corvette', 'Bolt', 'Impala', 'Suburban', 'Colorado', 'Aveo', 'Sonic', 'Trax', 'Volt']
'Chrysler': ['300', 'Pacifica', 'Voyager', 'Grand Caravan', '200', 'Sebring', 'PT Cruiser', 'Crossfire', 'Aspen', 'Town & Country']
'Dodge': ['Charger', 'Challenger', 'Durango', 'Journey', 'Grand Caravan', 'Ram', 'Dart', 'Avenger', 'Caliber', 'Magnum', 'Neon', 'Intrepid', 'Stratus', 'Viper']
'Jeep': ['Renegade', 'Compass', 'Cherokee', 'Grand Cherokee', 'Wrangler', 'Gladiator', 'Wagoneer', 'Patriot', 'Liberty', 'Commander']
'Alfa Romeo': ['Giulia', 'Stelvio', '4C', 'Giulietta', 'Mito', '159', 'Brera', '147', '156', '166', 'GT', 'Spider', 'GTV', '145', '146']
      'Aston Martin': ['DB11', 'Vantage', 'DBS', 'DBX', 'Rapide', 'Vanquish'],
      'Bentley': ['Continental', 'Flying Spur', 'Bentayga', 'Mulsanne'],
      'Ferrari': ['488', 'F8', 'Roma', 'Portofino', 'SF90', '812', 'GTC4Lusso', 'LaFerrari'],
      'Lamborghini': ['Huracan', 'Aventador', 'Urus', 'Gallardo'],
      'Maserati': ['Ghibli', 'Quattroporte', 'Levante', 'GranTurismo', 'MC20'],
      'McLaren': ['540C', '570S', '720S', 'GT', 'Artura', 'P1', '650S'],
      'Rolls-Royce': ['Ghost', 'Wraith', 'Dawn', 'Cullinan', 'Phantom'],
'Infiniti': ['Q30', 'Q50', 'Q60', 'QX30', 'QX50', 'QX60', 'QX80', 'Q70', 'G35', 'G37', 'M35', 'M37', 'FX35', 'FX45', 'EX35', 'Q45', 'I30', 'I35']
    };

    // Function to update models based on selected make
    function updateCarModels() {
      const makeSelect = document.getElementById('car_make_select');
      const modelSelect = document.getElementById('car_model_select');
      
      if (!makeSelect || !modelSelect) {
        return;
      }
      
      const selectedMake = makeSelect.value;
      const previousMake = makeSelect.getAttribute('data-previous-make') || '';
      
      // Clear existing options
      modelSelect.innerHTML = '<option value="">All Models</option>';
      
      // If make changed, clear the model selection
      if (selectedMake !== previousMake) {
        modelSelect.value = '';
      }
      
      // Store current make for next comparison
      makeSelect.setAttribute('data-previous-make', selectedMake);
      
      if (selectedMake && carModels[selectedMake]) {
        // Add models for selected make
        carModels[selectedMake].forEach(function(model) {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
      // If no make selected, just show "All Models" (already set above)
    }

    // Initialize when DOM is ready
    function initCarModelFilter() {
      const makeSelect = document.getElementById('car_make_select');
      const modelSelect = document.getElementById('car_model_select');
      
      if (makeSelect && modelSelect) {
        // Store initial make value
        makeSelect.setAttribute('data-previous-make', makeSelect.value || '');
        
        // Initialize models based on current make selection
        updateCarModels();
        
        // Update models when make changes
        makeSelect.addEventListener('change', function() {
          updateCarModels();
        });
      }
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarModelFilter);
    } else {
      // DOM already loaded
      initCarModelFilter();
    }
  </script>

  <!-- Popular right now / Trending searches (homepage only) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="trending-searches-section" id="trendingSearchesSection">
    <div class="container">
      <h2 class="trending-searches-title">Popular right now</h2>
      <div class="trending-searches-links">
        <% motors_cat = Category.find_by("name ILIKE ?", "%motor%") %>
        <% cars_under_5k_params = motors_cat ? { category_id: motors_cat.id, subcategory: "Car", max_price: 5000 } : { search: "car", max_price: 5000 } %>
        <%= link_to listings_path(cars_under_5k_params), class: "trending-search-link" do %>Cars under ‚Ç¨5,000<% end %>
        <% electronics_cat = Category.find_by("name ILIKE ?", "%electronic%") %>
        <%= link_to electronics_cat ? listings_path(category_id: electronics_cat.id, search: "iPhone", location: "Dublin") : listings_path(search: "iPhone", location: "Dublin"), class: "trending-search-link" do %>iPhones in Dublin<% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Categories Section (only show on homepage, not on filtered listings page or browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="categories-section" id="homeCategoriesSection">
    <div class="container">
      <div class="categories-row">
        <% motors_category = Category.find_by("name ILIKE ?", "%motor%") || Category.find_by("name ILIKE ?", "%car%") %>
        <%= link_to motors_category ? "/listings?category_id=#{motors_category.id}" : listings_path(search: "Motors"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #3B82F6;">üöó</div>
          <span>Cars</span>
        <% end %>
        <%= link_to listings_path(search: "Property"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #22C55E;">üè†</div>
          <span>Properties</span>
        <% end %>
        <%= link_to listings_path(search: "Services"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #EF4444;">üîß</div>
          <span>Services</span>
        <% end %>
        <%= link_to listings_path(search: "Electronics"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #A855F7;">üì±</div>
          <span>Electronics</span>
        <% end %>
        <%= link_to listings_path(search: "Animals"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #3B82F6;">üêæ</div>
          <span>Animals</span>
        <% end %>
        <% furniture_category = Category.find_by("name ILIKE ?", "%furniture%") %>
        <%= link_to furniture_category ? "/listings?category_id=#{furniture_category.id}" : listings_path(search: "Furniture"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #8B4513;">ü™ë</div>
          <span>Furniture</span>
        <% end %>
        <%= link_to listings_path(search: "Farming"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #84CC16;">üöú</div>
          <span>Farming</span>
        <% end %>
        <%= link_to listings_path(search: "Music + Education"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #EC4899;">üéµ</div>
          <span>Music + Education</span>
        <% end %>
        <%= link_to listings_path(search: "Sport + Hobbies"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #F59E0B;">‚öΩ</div>
          <span>Sport + Hobbies</span>
        <% end %>
        <%= link_to listings_path(search: "Baby + Kids"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #A78BFA;">üë∂</div>
          <span>Baby + Kids</span>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Browse by Category (clickable cards, no form - show when on browse page with no filters) -->
  <% has_filters = params[:make].present? || params[:model].present? || params[:min_year].present? || params[:max_year].present? || params[:min_mileage].present? || params[:max_mileage].present? || params[:min_price].present? || params[:max_price].present? || params[:subcategory].present? %>
  <% if params[:category_id].blank? && params[:search].blank? && params[:location].blank? && is_browse_page && !has_filters %>
  <section class="browse-category-section">
    <div class="container">
      <h2 class="browse-category-title">Browse by Category</h2>
      <div class="browse-category-grid">
        <%= link_to listings_path, class: "browse-category-card" do %>
          <span class="browse-category-icon" aria-hidden="true">üìã</span>
          <span class="browse-category-name">All Categories</span>
          <span class="browse-category-count"><%= Listing.available.count %> ads</span>
        <% end %>
        <% @categories.each do |category| %>
          <%= link_to listings_path(category_id: category.id), class: "browse-category-card" do %>
            <span class="browse-category-icon" aria-hidden="true"><%= category_icon(category) %></span>
            <span class="browse-category-name"><%= category.name %></span>
            <span class="browse-category-count"><%= category.listings.available.count %> ads</span>
          <% end %>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <script>
    // Car make-model relationships for Buy page
    const carModelsBuy = {
      'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'TT', 'R8', 'e-tron', 'e-tron GT', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
      'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X4 M', 'X5 M', 'X6 M'],
      'Mercedes-Benz': ['A-Class', 'B-Class', 'C-Class', 'E-Class', 'S-Class', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'SL', 'AMG GT', 'EQC', 'EQS', 'EQE', 'C63 AMG', 'E63 AMG', 'S63 AMG', 'G63 AMG'],
'Volkswagen': ['Golf', 'Polo', 'Passat', 'Jetta', 'Tiguan', 'Touareg', 'Arteon', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.Buzz', 'Beetle', 'Up!', 'Scirocco', 'Sharan', 'Touran', 'Amarok', 'Caddy', 'Fox', 'Lupo', 'Eos', 'CC', 'Phaeton']
'Ford': ['Fiesta', 'Focus', 'Mondeo', 'Kuga', 'Edge', 'Explorer', 'Mustang', 'Puma', 'EcoSport', 'Ranger', 'Transit', 'S-Max', 'Galaxy', 'Tourneo', 'Fusion', 'Escape', 'Expedition', 'F-150', 'Ka', 'C-Max', 'Grand C-Max', 'Bronco', 'Maverick', 'Territory', 'Falcon']
'Toyota': ['Aygo', 'Yaris', 'Corolla', 'Camry', 'Prius', 'C-HR', 'RAV4', 'Highlander', 'Land Cruiser', 'Hilux', 'Proace', 'Avensis', 'Auris', 'Verso', 'GT86', 'Supra', 'bZ4X', 'Vitz', 'Celica', 'MR2', 'Tundra', 'Sequoia', 'Sienna', 'Tacoma', '4Runner', 'Matrix', 'FJ Cruiser']
'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot', 'Fit', 'Jazz', 'Insight', 'Ridgeline', 'Passport', 'Odyssey', 'e', 'CR-Z', 'NSX', 'City', 'S2000', 'Prelude', 'Element', 'Crosstour']
'Hyundai': ['i10', 'i20', 'i30', 'Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Ioniq', 'Palisade', 'Venue', 'Nexo', 'IONIQ 5', 'IONIQ 6', 'Genesis', 'Veloster', 'Accent', 'Azera', 'Equus', 'Veracruz', 'Tiburon', 'XG', 'Grandeur']
'Nissan': ['Micra', 'Sentra', 'Altima', 'Maxima', 'Juke', 'Qashqai', 'X-Trail', 'Pathfinder', 'Armada', 'Leaf', 'Ariya', '370Z', 'GT-R', 'Navara', 'Note', 'Pulsar', 'Almera', 'Primera', '350Z', 'Murano', 'Rogue', 'Frontier', 'Titan', 'Versa', 'Kicks']
'Renault': ['Clio', 'Megane', 'Scenic', 'Kadjar', 'Captur', 'Koleos', 'Talisman', 'Zoe', 'Twingo', 'Kangoo', 'Trafic', 'Master', 'Arkana', 'Austral', 'Laguna', 'Fluence', 'Wind', 'Modus', 'Espace', 'Vel Satis']
'Peugeot': ['108', '208', '308', '508', '2008', '3008', '5008', 'Partner', 'Expert', 'Boxer', 'Rifter', 'Traveller', 'e-208', 'e-2008', '107', '207', '307', '407', '607', '1007', '4007', 'RCZ']
'Citroen': ['C1', 'C3', 'C4', 'C5', 'Berlingo', 'Cactus', 'C4 Picasso', 'Grand C4 Picasso', 'SpaceTourer', 'Jumper', 'e-C4', 'Ami', 'C2', 'C6', 'C8', 'DS3', 'DS4', 'DS5', 'Xantia', 'Xsara', 'C15']
'Skoda': ['Fabia', 'Octavia', 'Superb', 'Kodiaq', 'Karoq', 'Kamiq', 'Scala', 'Enyaq', 'Rapid', 'Yeti', 'Citigo']
'Seat': ['Ibiza', 'Leon', 'Ateca', 'Tarraco', 'Arona', 'Formentor', 'Alhambra', 'Altea', 'Toledo', 'Cupra Born', 'Cupra Formentor', 'Mii', 'Exeo', 'Cordoba']
'Mazda': ['Mazda2', 'Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'CX-30', 'MX-5', 'MX-30', 'BT-50', 'CX-50', 'CX-60', 'CX-70', 'CX-90', 'RX-7', 'RX-8', 'MPV', 'Tribute']
'Kia': ['Picanto', 'Rio', 'Ceed', 'Optima', 'Sportage', 'Sorento', 'Stonic', 'Niro', 'EV6', 'Soul', 'Seltos', 'Telluride', 'Carnival', 'Stinger', 'Ceed SW', 'ProCeed', 'Xceed', 'Mohave', 'Borrego']
'Volvo': ['V40', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'S60', 'S90', 'C30', 'C70', 'XC70', 'EX30', 'EX90', 'S40', 'S80', 'V50', 'V70', 'XC30', '850', '240', '740', '940']
'Opel': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e', 'Vectra', 'Zafira', 'Meriva', 'Tigra', 'Agila', 'Antara', 'Cascada']
'Vauxhall': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e', 'Vectra', 'Zafira', 'Meriva', 'Tigra', 'Agila', 'Antara', 'Cascada']
'Fiat': ['500', 'Panda', 'Punto', 'Tipo', '500X', '500L', 'Doblo', 'Qubo', 'Talento', 'Ducato', '500e', 'Bravo', 'Brava', 'Stilo', 'Multipla', 'Ulysse', 'Sedici', 'Linea', 'Grande Punto']
'Suzuki': ['Swift', 'Vitara', 'S-Cross', 'Jimny', 'Ignis', 'SX4', 'Baleno', 'Celerio', 'Across', 'Splash', 'Kizashi', 'Grand Vitara', 'XL7', 'Samurai']
'Mitsubishi': ['Mirage', 'Lancer', 'Outlander', 'ASX', 'Eclipse Cross', 'Shogun', 'Pajero', 'i-MiEV', 'Colt', 'Galant', 'Eclipse', '3000GT', 'Diamante', 'Montero', 'Space Star']
'Subaru': ['Impreza', 'Legacy', 'Outback', 'Forester', 'XV', 'BRZ', 'Ascent', 'WRX', 'Levorg', 'Tribeca', 'Baja', 'SVX', 'Justy', 'B9 Tribeca']
'Jaguar': ['XE', 'XF', 'XJ', 'F-Pace', 'E-Pace', 'I-Pace', 'F-Type', 'XK', 'X-Type', 'S-Type', 'XFR', 'XKR', 'XJ220']
'Land Rover': ['Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Sport', 'Range Rover Evoque', 'Defender', 'Range Rover Velar', 'Freelander', 'LR2', 'LR3', 'LR4']
'Lexus': ['IS', 'ES', 'GS', 'LS', 'NX', 'RX', 'UX', 'GX', 'LX', 'LC', 'RC', 'CT', 'SC', 'HS', 'LFA']
'Porsche': ['911', '718', 'Panamera', 'Macan', 'Cayenne', 'Taycan', 'Boxster', 'Cayman', '924', '928', '944', '968', '959', 'Carrera GT']
      'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Cybertruck'],
'Mini': ['Hatch', 'Clubman', 'Countryman', 'Convertible', 'Paceman', 'Coupe', 'Roadster', 'One', 'Cooper', 'Cooper S', 'John Cooper Works', 'Electric']
      'Smart': ['Fortwo', 'Forfour', 'EQ Fortwo', 'EQ Forfour'],
      'Dacia': ['Sandero', 'Duster', 'Logan', 'Lodgy', 'Dokker', 'Spring'],
'Chevrolet': ['Spark', 'Cruze', 'Malibu', 'Equinox', 'Tahoe', 'Silverado', 'Traverse', 'Blazer', 'Camaro', 'Corvette', 'Bolt', 'Impala', 'Suburban', 'Colorado', 'Aveo', 'Sonic', 'Trax', 'Volt']
'Chrysler': ['300', 'Pacifica', 'Voyager', 'Grand Caravan', '200', 'Sebring', 'PT Cruiser', 'Crossfire', 'Aspen', 'Town & Country']
'Dodge': ['Charger', 'Challenger', 'Durango', 'Journey', 'Grand Caravan', 'Ram', 'Dart', 'Avenger', 'Caliber', 'Magnum', 'Neon', 'Intrepid', 'Stratus', 'Viper']
'Jeep': ['Renegade', 'Compass', 'Cherokee', 'Grand Cherokee', 'Wrangler', 'Gladiator', 'Wagoneer', 'Patriot', 'Liberty', 'Commander']
'Alfa Romeo': ['Giulia', 'Stelvio', '4C', 'Giulietta', 'Mito', '159', 'Brera', '147', '156', '166', 'GT', 'Spider', 'GTV', '145', '146']
      'Aston Martin': ['DB11', 'Vantage', 'DBS', 'DBX', 'Rapide', 'Vanquish'],
      'Bentley': ['Continental', 'Flying Spur', 'Bentayga', 'Mulsanne'],
      'Ferrari': ['488', 'F8', 'Roma', 'Portofino', 'SF90', '812', 'GTC4Lusso', 'LaFerrari'],
      'Lamborghini': ['Huracan', 'Aventador', 'Urus', 'Gallardo'],
      'Maserati': ['Ghibli', 'Quattroporte', 'Levante', 'GranTurismo', 'MC20'],
      'McLaren': ['540C', '570S', '720S', 'GT', 'Artura', 'P1', '650S'],
      'Rolls-Royce': ['Ghost', 'Wraith', 'Dawn', 'Cullinan', 'Phantom'],
'Infiniti': ['Q30', 'Q50', 'Q60', 'QX30', 'QX50', 'QX60', 'QX80', 'Q70', 'G35', 'G37', 'M35', 'M37', 'FX35', 'FX45', 'EX35', 'Q45', 'I30', 'I35']
    };

    function updateCarModelsBuy() {
      const makeSelect = document.getElementById('car_make_select_buy');
      const modelSelect = document.getElementById('car_model_select_buy');
      
      if (!makeSelect || !modelSelect) {
        return;
      }
      
      const selectedMake = makeSelect.value;
      const previousMake = makeSelect.getAttribute('data-previous-make') || '';
      
      modelSelect.innerHTML = '<option value="">All Models</option>';
      
      if (selectedMake !== previousMake) {
        modelSelect.value = '';
      }
      
      makeSelect.setAttribute('data-previous-make', selectedMake);
      
      if (selectedMake && carModelsBuy[selectedMake]) {
        carModelsBuy[selectedMake].forEach(function(model) {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
      // If no make selected, just show "All Models" (already set above)
    }

    function initCarModelFilterBuy() {
      const makeSelect = document.getElementById('car_make_select_buy');
      const modelSelect = document.getElementById('car_model_select_buy');
      
      if (makeSelect && modelSelect) {
        makeSelect.setAttribute('data-previous-make', makeSelect.value || '');
        updateCarModelsBuy();
        makeSelect.addEventListener('change', function() {
          updateCarModelsBuy();
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarModelFilterBuy);
    } else {
      initCarModelFilterBuy();
    }
  </script>

  <!-- Search Bar (show on results pages) -->
  <% if params[:category_id].present? || params[:search].present? || params[:location].present? || is_browse_page %>
  <section class="search-results-header">
    <div class="container">
      <% bc_items = [[ "Home", root_path ]] %>
      <% if @selected_category %>
        <% bc_items << [ @selected_category.name, nil ] %>
      <% elsif params[:search].present? %>
        <% bc_items << [ "Search results", nil ] %>
      <% elsif is_browse_page %>
        <% bc_items << [ "All listings", nil ] %>
      <% end %>
      <%= render "shared/breadcrumbs", items: bc_items if bc_items.size > 1 %>
      <div class="section-header">
        <% if has_filters && params[:subcategory] == "Car" %>
          <h2 class="section-title">Car Search Results</h2>
        <% elsif @selected_category %>
          <h2 class="section-title"><%= @selected_category.name %> Listings</h2>
        <% elsif params[:location].present? && params[:search].blank? && params[:category_id].blank? %>
          <h2 class="section-title">Listings in <%= params[:location] %></h2>
        <% elsif params[:search].present? || params[:location].present? || params[:category_id].present? %>
          <h2 class="section-title">Search Results</h2>
        <% elsif is_browse_page %>
          <h2 class="section-title">All Listings</h2>
        <% end %>
      </div>
      <!-- Desktop search box (hidden on mobile) -->
      <div class="search-box-results">
        <%= form_with url: listings_path, method: :get, local: true, class: "search-form-results" do |f| %>
          <% if params[:category_id].present? %>
            <%= f.hidden_field :category_id, value: params[:category_id] %>
          <% end %>
          <div class="search-input-group-results">
            <%= f.text_field :search, placeholder: "Search", class: "search-input", value: params[:search] %>
            <%= f.text_field :location, placeholder: "Location (e.g., Dublin)", class: "search-input location-input", value: params[:location] %>
            <%= f.submit "Search", class: "search-button" %>
          </div>
        <% end %>
      </div>
      <!-- Mobile search: one row [search + location] + [Filters] when filters shown; location in sheet -->
      <div class="mobile-search-row-with-filters">
        <div class="mobile-search-bar">
          <%= form_with url: listings_path, method: :get, local: true, class: "mobile-search-form" do |f| %>
            <% if params[:category_id].present? %>
              <%= f.hidden_field :category_id, value: params[:category_id] %>
            <% end %>
            <div class="mobile-search-stack">
              <div class="mobile-search-input-wrapper mobile-search-main-row">
                <%= f.text_field :search, placeholder: "Search", class: "mobile-search-input", value: params[:search] %>
                <button type="submit" class="mobile-search-submit-btn mobile-search-inline-btn" aria-label="Search">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
              <div class="mobile-search-input-wrapper mobile-search-location-row">
                <%= f.text_field :location, placeholder: "Location (e.g. Dublin)", class: "mobile-search-input", value: params[:location], "aria-label" => "Location" %>
              </div>
              <button type="submit" class="mobile-search-submit-btn mobile-search-full-width-btn" aria-label="Search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Search
              </button>
            </div>
          <% end %>
        </div>
        <% motors_category = Category.find_by("name ILIKE ?", "%motor%") || Category.find_by("name ILIKE ?", "%car%") %>
        <% is_motors_category_selected = motors_category && @selected_category&.id == motors_category.id %>
        <% show_filters_section = params[:category_id].present? || params[:search].present? || params[:location].present? || is_browse_page %>
        <% filter_form_subcategories = @selected_category ? subcategories_for_category(@selected_category) : [] %>
        <% active_filter_count = [params[:make], params[:model], params[:min_year], params[:max_year], params[:min_mileage], params[:max_mileage], params[:min_price], params[:max_price], params[:subcategory], params[:location], params[:include_sold], params[:posted_today], params[:has_images]].count { |v| v.present? } %>
        <% if show_filters_section %>
        <button type="button" class="btn-mobile-filters btn-mobile-filters-inline" id="mobileFiltersBtn" data-active-count="<%= active_filter_count %>">
          <span class="btn-mobile-filters-label">Filters</span>
          <% if active_filter_count > 0 %>
            <span class="btn-mobile-filters-count"><%= active_filter_count %></span>
          <% end %>
        </button>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Category filters (hidden by default, shown when "Show Filters" is clicked) -->
  <% motors_category = Category.find_by("name ILIKE ?", "%motor%") || Category.find_by("name ILIKE ?", "%car%") %>
  <% is_motors_category_selected = motors_category && @selected_category&.id == motors_category.id %>
  <% show_filters_section = params[:category_id].present? || params[:search].present? || params[:location].present? || is_browse_page %>
  <% filter_form_subcategories = @selected_category ? subcategories_for_category(@selected_category) : [] %>
  <% active_filter_count = [params[:make], params[:model], params[:min_year], params[:max_year], params[:min_mileage], params[:max_mileage], params[:min_price], params[:max_price], params[:subcategory], params[:location], params[:include_sold], params[:posted_today], params[:has_images]].count { |v| v.present? } %>
  <% mobile_filters_clear_url = listings_path(params.permit(:category_id, :search, :sort).to_h.symbolize_keys) %>
  <% if show_filters_section %>
  <section class="general-filter-section general-filter-section-desktop" id="categoryFiltersSection">
    <div class="container">
      <div class="general-filter-box">
        <h2 class="general-filter-title"><%= @selected_category ? "Filter #{@selected_category.name}" : "Filters" %></h2>
        <%= form_with url: listings_path, method: :get, local: true, class: "general-filter-form", id: "category-filter-form" do |f| %>
          <%= f.hidden_field :sort, value: params[:sort] if params[:sort].present? %>
          <%= render "listings/filter_form_fields", f: f, selected_category: @selected_category, subcategories: filter_form_subcategories, is_motors_category_selected: is_motors_category_selected, categories: @categories %>
          <div class="form-actions">
            <%= f.submit "Apply Filters", class: "general-filter-button" %>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <section class="filters-button-container filters-button-container-desktop">
    <div class="container">
      <button type="button" class="btn-show-filters" id="toggleCategoryFiltersBtn">Show Filters</button>
    </div>
  </section>

  <% show_listings_search_header = params[:category_id].present? || params[:search].present? || params[:location].present? || is_browse_page %>
  <section class="filters-button-container-mobile <%= 'filters-button-container-mobile-hidden' if show_listings_search_header %>">
    <div class="container">
      <% unless show_listings_search_header %>
      <button type="button" class="btn-mobile-filters" id="mobileFiltersBtn" data-active-count="<%= active_filter_count %>">
        <span class="btn-mobile-filters-label">Filters</span>
        <% if active_filter_count > 0 %>
          <span class="btn-mobile-filters-count"><%= active_filter_count %></span>
        <% end %>
      </button>
      <% end %>
    </div>
  </section>

  <div class="mobile-filters-overlay" id="mobileFiltersOverlay" aria-hidden="true"></div>
  <div class="mobile-filters-bottom-sheet" id="mobileFiltersSheet" role="dialog" aria-labelledby="mobileFiltersSheetTitle" aria-modal="true">
    <div class="mobile-filters-sheet-header">
      <h2 class="mobile-filters-sheet-title" id="mobileFiltersSheetTitle">Filters</h2>
      <button type="button" class="mobile-filters-sheet-close" id="mobileFiltersSheetClose" aria-label="Close">√ó</button>
    </div>
    <div class="mobile-filters-sheet-body">
      <%= form_with url: listings_path, method: :get, local: true, class: "general-filter-form mobile-filters-form", id: "mobileFiltersForm" do |f| %>
        <%= f.hidden_field :search, value: params[:search] if params[:search].present? %>
        <%= f.hidden_field :sort, value: params[:sort] if params[:sort].present? %>
        <%= render "listings/filter_form_fields", f: f, selected_category: @selected_category, subcategories: filter_form_subcategories, is_motors_category_selected: is_motors_category_selected, categories: @categories, form_suffix: "mobile" %>
        <div class="mobile-filters-sheet-actions">
          <%= link_to "Clear all", mobile_filters_clear_url, class: "mobile-filters-clear-all" %>
          <%= f.submit "Apply filters", class: "general-filter-button mobile-filters-apply" %>
        </div>
      <% end %>
    </div>
  </div>
  <% end %>

  <!-- Featured Listings Section -->
  <section class="listings-section">
    <div class="container">
      <div class="homepage-main-content">
        <div class="featured-listings-column">
          <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
          <div class="section-header">
            <h2 class="section-title">Featured Listings</h2>
            <% unless is_browse_page || has_filters %>
              <%= link_to "View All >", listings_path, class: "view-all-link" %>
            <% end %>
          </div>
          <% end %>

      
      <% if @listings.any? %>
        <% if @selected_category || params[:category_id].present? || params[:search].present? || params[:location].present? || has_filters %>
          <% total_count = defined?(@listings_total_count) ? @listings_total_count : @listings.count %>
          <% sort_params = params.permit(:category_id, :search, :location, :make, :model, :min_year, :max_year, :min_mileage, :max_mileage, :min_price, :max_price, :subcategory, :include_sold, :posted_today, :has_images).to_h %>
          <div class="listings-toolbar">
            <p class="filter-info" style="margin: 0; color: #666; font-size: 0.9375rem;">
              Showing <%= total_count %> <%= total_count == 1 ? 'listing' : 'listings' %>
            <% if has_filters && params[:subcategory] == "Car" %>
              <% filter_parts = [] %>
              <% filter_parts << params[:make] if params[:make].present? %>
              <% filter_parts << params[:model] if params[:model].present? %>
              <% if filter_parts.any? %>
                matching <%= filter_parts.join(' ') %>
              <% else %>
                matching your search criteria
              <% end %>
            <% elsif @selected_category %>
              in <%= @selected_category.name %>
            <% elsif params[:location].present? %>
              in <%= params[:location] %>
            <% end %>
            </p>
            <div class="sort-dropdown-wrap">
              <label for="sort_select" class="sort-label">Sort:</label>
              <select id="sort_select" class="sort-select" aria-label="Sort results">
                <option value="newest" <%= params[:sort] == 'newest' || params[:sort].blank? ? 'selected' : '' %>>Newest first</option>
                <option value="price_asc" <%= params[:sort] == 'price_asc' ? 'selected' : '' %>>Price: low to high</option>
                <option value="price_desc" <%= params[:sort] == 'price_desc' ? 'selected' : '' %>>Price: high to low</option>
              </select>
            </div>
          </div>
          <% if user_signed_in? %>
            <%= form_with url: saved_searches_path, method: :post, local: true, class: "save-search-form" do |f| %>
              <%= f.hidden_field :search, value: params[:search] %>
              <%= f.hidden_field :location, value: params[:location] %>
              <%= f.hidden_field :category_id, value: params[:category_id] %>
              <%= f.hidden_field :subcategory, value: params[:subcategory] %>
              <%= f.hidden_field :make, value: params[:make] %>
              <%= f.hidden_field :model, value: params[:model] %>
              <%= f.hidden_field :min_year, value: params[:min_year] %>
              <%= f.hidden_field :max_year, value: params[:max_year] %>
              <%= f.hidden_field :min_mileage, value: params[:min_mileage] %>
              <%= f.hidden_field :max_mileage, value: params[:max_mileage] %>
              <%= f.hidden_field :min_price, value: params[:min_price] %>
              <%= f.hidden_field :max_price, value: params[:max_price] %>
              <%= f.hidden_field :include_sold, value: params[:include_sold] %>
              <%= f.text_field :name, value: params[:name], placeholder: "Search name (optional)", class: "save-search-name-input" %>
              <%= f.submit "Save this search", class: "btn-save-search" %>
            <% end %>
          <% end %>
        <% end %>
        <% listings_to_show = if @selected_category || params[:category_id].present? || params[:search].present? || params[:location].present? || has_filters || is_browse_page
                                 @listings
                               else
                                 (@featured_listings || @listings.order(Arel.sql('RANDOM()')).limit(4))
                               end %>
        <% is_homepage_grid = !is_browse_page && !params[:category_id].present? && !params[:search].present? && !params[:location].present? && !has_filters %>
        <div class="listings-grid <%= 'homepage-grid' if is_homepage_grid %>">
          <% listings_to_show.each do |listing| %>
            <div class="listing-card<%= ' listing-card-boosted' if listing.boosted? %>">
              <%= link_to listing, class: "listing-card-link" do %>
                <div class="listing-image">
                  <% if listing.images.attached? %>
                    <%= image_tag listing.ordered_images.first, class: "listing-card-image" %>
                  <% else %>
                    <div class="image-placeholder">
                      <span>üì∑</span>
                    </div>
                  <% end %>
                  <% if listing.sold? %>
                    <span class="listing-badge-sold-overlay">Sold</span>
                  <% end %>
                </div>
                <div class="listing-content">
                  <% is_new = listing.created_at > 1.day.ago %>
                  <% is_urgent = listing.extra_fields&.dig('urgent').to_s == 'true' || listing.extra_fields&.dig('urgent') == true %>
                  <% if listing.featured || is_new || listing.price_dropped? || is_urgent || listing.boosted? %>
                    <div class="listing-badges">
                      <% if listing.boosted? %><span class="listing-badge listing-badge-boosted">Boosted<%= listing.boost_time_left ? " (#{listing.boost_time_left})" : "" %></span><% end %>
                      <% if listing.featured %><span class="listing-badge listing-badge-featured">Featured</span><% end %>
                      <% if is_new %><span class="listing-badge listing-badge-new">New</span><% end %>
                      <% if listing.price_dropped? %><span class="listing-badge listing-badge-price-drop">Price Drop</span><% end %>
                      <% if is_urgent %><span class="listing-badge listing-badge-urgent">Urgent</span><% end %>
                    </div>
                  <% end %>
                  <h3 class="listing-title">
                    <%= listing.title %>
                  </h3>
                  <div class="listing-details">
                    <p class="listing-location">üìç <%= listing.city || "Location not specified" %></p>
                    <p class="listing-posted">Posted <%= time_ago_in_words(listing.created_at) %> ago</p>
                    <% if listing.extra_fields&.dig('year') || listing.extra_fields&.dig('mileage') || listing.extra_fields&.dig('engine_size') || listing.extra_fields&.dig('fuel_type') %>
                      <p class="listing-specs">
                        <% if listing.extra_fields&.dig('year') %>
                          <span><%= listing.extra_fields['year'] %></span>
                        <% end %>
                        <% if listing.extra_fields&.dig('mileage') %>
                          <span><%= number_with_delimiter(listing.extra_fields['mileage'].to_i) %> km</span>
                        <% end %>
                        <% if listing.extra_fields&.dig('engine_size') %>
                          <span><%= listing.extra_fields['engine_size'].to_s.gsub(/\s*L\s*/i, '').gsub(/\s*Litre\s*/i, '').gsub(/\s*Liter\s*/i, '') %>L</span>
                        <% end %>
                        <% if listing.extra_fields&.dig('fuel_type') %>
                          <span><%= listing.extra_fields['fuel_type'] %></span>
                        <% end %>
                      </p>
                    <% end %>
                  </div>
                  <div class="listing-footer">
                    <span class="listing-price">
                      <% if listing.price %>
                        ‚Ç¨<%= number_with_delimiter(listing.price.to_i) %>
                      <% else %>
                        Price on request
                      <% end %>
                    </span>
                    <span class="btn-view">View</span>
                  </div>
                </div>
              <% end %>
              <% if user_signed_in? %>
                <% is_favorited = current_user.favorites.exists?(listing_id: listing.id) %>
                <% favorite = current_user.favorites.find_by(listing_id: listing.id) if is_favorited %>
                <div class="favorite-heart-container" data-listing-id="<%= listing.id %>" data-favorite-id="<%= favorite&.id %>">
                  <button class="favorite-heart-btn <%= 'favorite-heart-active' if is_favorited %>" 
                          data-listing-id="<%= listing.id %>"
                          data-favorited="<%= is_favorited %>"
                          title="<%= is_favorited ? 'Remove from favorites' : 'Add to favorites' %>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="<%= is_favorited ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                  </button>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
        <% if defined?(@listings_total_pages) && @listings_total_pages > 1 %>
          <div class="pagination-wrapper">
            <nav class="pagination" aria-label="Pagination">
              <% pagination_params = params.permit(:category_id, :search, :location, :make, :model, :min_year, :max_year, :min_mileage, :max_mileage, :min_price, :max_price, :subcategory, :include_sold, :posted_today, :has_images, :sort).to_h %>
              <% if @listings_current_page > 1 %>
                <%= link_to "‚Üê Previous", listings_path(pagination_params.merge(page: @listings_current_page - 1)), class: "page-link prev" %>
              <% end %>
              <span class="page-info">
                Page <%= @listings_current_page %> of <%= @listings_total_pages %>
              </span>
              <% (@listings_current_page - 2).upto(@listings_current_page + 2).each do |p| %>
                <% next if p < 1 || p > @listings_total_pages %>
                <% if p == @listings_current_page %>
                  <span class="current"><%= p %></span>
                <% else %>
                  <%= link_to p, listings_path(pagination_params.merge(page: p)), class: "page-link" %>
                <% end %>
              <% end %>
              <% if @listings_current_page < @listings_total_pages %>
                <%= link_to "Next ‚Üí", listings_path(pagination_params.merge(page: @listings_current_page + 1)), class: "page-link next" %>
              <% end %>
            </nav>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <p class="empty-state-heading">Nothing here yet</p>
          <p class="empty-message">We couldn‚Äôt find any ads matching your search. Try different keywords, a wider location, or browse categories below.</p>
          <div class="empty-state-actions">
            <%= link_to "Browse all ads", listings_path, class: "empty-state-link" %>
            <% if @categories.any? %>
              <span class="empty-state-sep">or</span>
              <div class="empty-state-categories">
                <% @categories.first(4).each do |cat| %>
                  <%= link_to cat.name, listings_path(category_id: cat.id), class: "empty-state-link empty-state-link-cat" %>
                <% end %>
              </div>
            <% end %>
          </div>
          <% motors_cat_empty = Category.find_by("name ILIKE ?", "%motor%") %>
<% cars_under_5k_params_empty = motors_cat_empty ? { category_id: motors_cat_empty.id, subcategory: "Car", max_price: 5000 } : { search: "car", max_price: 5000 } %>
<% electronics_cat_empty = Category.find_by("name ILIKE ?", "%electronic%") %>
<% iphones_dublin_params_empty = electronics_cat_empty ? { category_id: electronics_cat_empty.id, search: "iPhone", location: "Dublin" } : { search: "iPhone", location: "Dublin" } %>
<p class="empty-state-sub">Popular: <%= link_to "Cars under ‚Ç¨5,000", listings_path(cars_under_5k_params_empty), class: "link" %> ¬∑ <%= link_to "iPhones in Dublin", listings_path(iphones_dublin_params_empty), class: "link" %></p>
        </div>
      <% end %>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section (only show on homepage, not on browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="cta-section">
    <div class="container">
      <h2>Ready to sell something?</h2>
      <p>Post your ad for free - it only takes a minute!</p>
      <%= link_to "Post Your Ad Now", new_listing_path, class: "btn-cta" %>
    </div>
  </section>
  <% end %>
</div>

<script>
  (function() {
    var form = document.getElementById('category-filter-form');
    var hidden = document.getElementById('category_id_submit');
    var mobileSelect = document.getElementById('category_id_mobile');
    if (form && hidden) {
      if (mobileSelect) {
        mobileSelect.addEventListener('change', function() {
          hidden.value = this.value || '';
          form.submit();
        });
      }
      form.querySelectorAll('.category-radio-desktop').forEach(function(radio) {
        radio.addEventListener('change', function() {
          hidden.value = this.value || '';
          form.submit();
        });
      });
    }
  })();
  function initCategoryFiltersToggle() {
    const toggleBtn = document.getElementById('toggleCategoryFiltersBtn');
    const filtersSection = document.getElementById('categoryFiltersSection');
    if (!toggleBtn || !filtersSection) return;
    if (toggleBtn.hasAttribute('data-filters-initialized')) return;
    toggleBtn.setAttribute('data-filters-initialized', 'true');
    toggleBtn.addEventListener('click', function() {
      const isVisible = filtersSection.classList.contains('show');
      if (isVisible) {
        filtersSection.classList.remove('show');
        toggleBtn.textContent = 'Show Filters';
        toggleBtn.classList.remove('hide');
      } else {
        filtersSection.classList.add('show');
        toggleBtn.textContent = 'Hide Filters';
        toggleBtn.classList.add('hide');
      }
    });
  }
  function initMobileFiltersSheet() {
    const btn = document.getElementById('mobileFiltersBtn');
    const overlay = document.getElementById('mobileFiltersOverlay');
    const sheet = document.getElementById('mobileFiltersSheet');
    const closeBtn = document.getElementById('mobileFiltersSheetClose');
    if (!btn || !sheet) return;
    if (btn.hasAttribute('data-mobile-filters-initialized')) return;
    btn.setAttribute('data-mobile-filters-initialized', 'true');
    function openSheet() {
      sheet.classList.add('open');
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    function closeSheet() {
      sheet.classList.remove('open');
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
    btn.addEventListener('click', openSheet);
    closeBtn.addEventListener('click', closeSheet);
    overlay.addEventListener('click', closeSheet);
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && sheet.classList.contains('open')) closeSheet();
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initCategoryFiltersToggle();
      initMobileFiltersSheet();
    });
  } else {
    initCategoryFiltersToggle();
    initMobileFiltersSheet();
  }
  document.addEventListener('turbo:load', function() {
    initCategoryFiltersToggle();
    initMobileFiltersSheet();
  });
  document.addEventListener('turbo:render', function() {
    initCategoryFiltersToggle();
    initMobileFiltersSheet();
  });

  (function initSortSelect() {
    var sortSelect = document.getElementById('sort_select');
    if (!sortSelect) return;
    sortSelect.addEventListener('change', function() {
      var url = new URL(window.location.href);
      url.searchParams.set('sort', this.value);
      url.searchParams.delete('page');
      window.location = url.toString();
    });
  })();
</script>
