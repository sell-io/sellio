<% content_for :title, "Dealo - Buy & Sell Anything" %>

<% if notice %>
  <div class="alert alert-success"><%= notice %></div>
<% end %>

<% is_browse_page = request.path == '/listings' %>

<div class="homepage">
  <!-- Hero Section with Search (only show on homepage, not on browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="hero-section" style="background-image: url('/SellioHomePage.png'); background-size: cover; background-position: center; position: relative;">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1 class="hero-title">Buy & Sell Anything</h1>
      <p class="hero-subtitle">Free classified ads in your area</p>
      
      <div class="search-box">
        <%= form_with url: listings_path, method: :get, local: true, class: "search-form" do |f| %>
          <div class="search-input-group">
            <%= f.text_field :search, placeholder: "What are you looking for?", class: "search-input" %>
            <%= f.text_field :location, placeholder: "Location (e.g., Dublin)", class: "search-input location-input" %>
            <%= f.submit "Search", class: "search-button" %>
          </div>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Car Filter Section (only show on homepage, not on browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <% motors_category = Category.find_by("name ILIKE ?", "%motor%") %>
  <% if motors_category %>
  <section class="car-filter-section">
    <div class="container">
      <div class="car-filter-box">
        <h2 class="car-filter-title">Looking for a new car?</h2>
        <%= form_with url: listings_path, method: :get, local: true, class: "car-filter-form" do |f| %>
          <%= f.hidden_field :category_id, value: motors_category.id %>
          <%= f.hidden_field :subcategory, value: "Car" %>
          <div class="car-filter-grid">
            <div class="car-filter-field">
              <%= f.label :make, "All Makes" %>
              <%= f.select :make, options_for_select([
                ['All Makes', ''],
                ['Alfa Romeo', 'Alfa Romeo'],
                ['Aston Martin', 'Aston Martin'],
                ['Audi', 'Audi'],
                ['Bentley', 'Bentley'],
                ['BMW', 'BMW'],
                ['Chevrolet', 'Chevrolet'],
                ['Chrysler', 'Chrysler'],
                ['Citroen', 'Citroen'],
                ['Dacia', 'Dacia'],
                ['Dodge', 'Dodge'],
                ['Ferrari', 'Ferrari'],
                ['Fiat', 'Fiat'],
                ['Ford', 'Ford'],
                ['Honda', 'Honda'],
                ['Hyundai', 'Hyundai'],
                ['Infiniti', 'Infiniti'],
                ['Jaguar', 'Jaguar'],
                ['Jeep', 'Jeep'],
                ['Kia', 'Kia'],
                ['Lamborghini', 'Lamborghini'],
                ['Land Rover', 'Land Rover'],
                ['Lexus', 'Lexus'],
                ['Maserati', 'Maserati'],
                ['Mazda', 'Mazda'],
                ['McLaren', 'McLaren'],
                ['Mercedes-Benz', 'Mercedes-Benz'],
                ['Mini', 'Mini'],
                ['Mitsubishi', 'Mitsubishi'],
                ['Nissan', 'Nissan'],
                ['Opel', 'Opel'],
                ['Peugeot', 'Peugeot'],
                ['Porsche', 'Porsche'],
                ['Renault', 'Renault'],
                ['Rolls-Royce', 'Rolls-Royce'],
                ['Seat', 'Seat'],
                ['Skoda', 'Skoda'],
                ['Smart', 'Smart'],
                ['Subaru', 'Subaru'],
                ['Suzuki', 'Suzuki'],
                ['Tesla', 'Tesla'],
                ['Toyota', 'Toyota'],
                ['Vauxhall', 'Vauxhall'],
                ['Volkswagen', 'Volkswagen'],
                ['Volvo', 'Volvo']
              ], params[:make]), {}, { class: "car-filter-select", id: "car_make_select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :model, "All Models" %>
              <%= f.select :model, options_for_select([['All Models', '']], params[:model]), {}, { class: "car-filter-select", id: "car_model_select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_year, "Min Year" %>
              <%= f.select :min_year, options_for_select([['Min Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:min_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_year, "Max Year" %>
              <%= f.select :max_year, options_for_select([['Max Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:max_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_price, "Min Price" %>
              <%= f.number_field :min_price, placeholder: "Min Price", class: "car-filter-input", min: 0, step: 100, value: params[:min_price] %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_price, "Max Price" %>
              <%= f.number_field :max_price, placeholder: "Max Price", class: "car-filter-input", min: 0, step: 100, value: params[:max_price] %>
            </div>
          </div>
          <div class="form-actions">
            <% car_count = Listing.where(category_id: motors_category.id).where("extra_fields->>'subcategory' = ?", "Car").count %>
            <%= f.submit "Search #{number_with_delimiter(car_count)} Cars", class: "car-filter-button" %>
          </div>
        <% end %>
      </div>
    </div>
  </section>
  
  <script>
    // Comprehensive car make-model relationships
    const carModels = {
      'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'TT', 'R8', 'e-tron', 'e-tron GT', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
      'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X4 M', 'X5 M', 'X6 M'],
      'Mercedes-Benz': ['A-Class', 'B-Class', 'C-Class', 'E-Class', 'S-Class', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'SL', 'AMG GT', 'EQC', 'EQS', 'EQE', 'C63 AMG', 'E63 AMG', 'S63 AMG', 'G63 AMG'],
      'Volkswagen': ['Golf', 'Polo', 'Passat', 'Jetta', 'Tiguan', 'Touareg', 'Arteon', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.Buzz', 'Beetle', 'Up!', 'Scirocco', 'Sharan', 'Touran', 'Amarok', 'Caddy'],
      'Ford': ['Fiesta', 'Focus', 'Mondeo', 'Kuga', 'Edge', 'Explorer', 'Mustang', 'Puma', 'EcoSport', 'Ranger', 'Transit', 'S-Max', 'Galaxy', 'Tourneo', 'Fusion', 'Escape', 'Expedition', 'F-150'],
      'Toyota': ['Aygo', 'Yaris', 'Corolla', 'Camry', 'Prius', 'C-HR', 'RAV4', 'Highlander', 'Land Cruiser', 'Hilux', 'Proace', 'Avensis', 'Auris', 'Verso', 'GT86', 'Supra', 'bZ4X'],
      'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot', 'Fit', 'Insight', 'Ridgeline', 'Passport', 'Odyssey', 'e', 'CR-Z', 'NSX'],
      'Hyundai': ['i10', 'i20', 'i30', 'Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Ioniq', 'Palisade', 'Venue', 'Nexo', 'IONIQ 5', 'IONIQ 6', 'Genesis', 'Veloster', 'Accent'],
      'Nissan': ['Micra', 'Sentra', 'Altima', 'Maxima', 'Juke', 'Qashqai', 'X-Trail', 'Pathfinder', 'Armada', 'Leaf', 'Ariya', '370Z', 'GT-R', 'Navara', 'Note', 'Pulsar'],
      'Renault': ['Clio', 'Megane', 'Scenic', 'Kadjar', 'Captur', 'Koleos', 'Talisman', 'Zoe', 'Twingo', 'Kangoo', 'Trafic', 'Master', 'Arkana', 'Austral'],
      'Peugeot': ['108', '208', '308', '508', '2008', '3008', '5008', 'Partner', 'Expert', 'Boxer', 'Rifter', 'Traveller', 'e-208', 'e-2008'],
      'Citroen': ['C1', 'C3', 'C4', 'C5', 'Berlingo', 'Cactus', 'C4 Picasso', 'Grand C4 Picasso', 'SpaceTourer', 'Jumper', 'e-C4', 'Ami'],
      'Skoda': ['Fabia', 'Octavia', 'Superb', 'Kodiaq', 'Karoq', 'Kamiq', 'Scala', 'Enyaq', 'Rapid', 'Yeti'],
      'Seat': ['Ibiza', 'Leon', 'Ateca', 'Tarraco', 'Arona', 'Formentor', 'Alhambra', 'Altea', 'Toledo', 'Cupra Born', 'Cupra Formentor'],
      'Mazda': ['Mazda2', 'Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'CX-30', 'MX-5', 'MX-30', 'BT-50'],
      'Kia': ['Picanto', 'Rio', 'Ceed', 'Optima', 'Sportage', 'Sorento', 'Stonic', 'Niro', 'EV6', 'Soul', 'Seltos', 'Telluride', 'Carnival', 'Stinger'],
      'Volvo': ['V40', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'S60', 'S90', 'C30', 'C70', 'XC70', 'EX30', 'EX90'],
      'Opel': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Vauxhall': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Fiat': ['500', 'Panda', 'Punto', 'Tipo', '500X', '500L', 'Doblo', 'Qubo', 'Talento', 'Ducato', '500e'],
      'Suzuki': ['Swift', 'Vitara', 'S-Cross', 'Jimny', 'Ignis', 'SX4', 'Baleno', 'Celerio', 'Across'],
      'Mitsubishi': ['Mirage', 'Lancer', 'Outlander', 'ASX', 'Eclipse Cross', 'Shogun', 'Pajero', 'i-MiEV'],
      'Subaru': ['Impreza', 'Legacy', 'Outback', 'Forester', 'XV', 'BRZ', 'Ascent', 'WRX', 'Levorg'],
      'Jaguar': ['XE', 'XF', 'XJ', 'F-Pace', 'E-Pace', 'I-Pace', 'F-Type', 'XK', 'X-Type'],
      'Land Rover': ['Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Sport', 'Range Rover Evoque', 'Defender', 'Range Rover Velar'],
      'Lexus': ['IS', 'ES', 'GS', 'LS', 'NX', 'RX', 'UX', 'GX', 'LX', 'LC', 'RC', 'CT'],
      'Porsche': ['911', '718', 'Panamera', 'Macan', 'Cayenne', 'Taycan', 'Boxster', 'Cayman'],
      'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Cybertruck'],
      'Mini': ['Hatch', 'Clubman', 'Countryman', 'Convertible', 'Paceman', 'Coupe', 'Roadster', 'One'],
      'Smart': ['Fortwo', 'Forfour', 'EQ Fortwo', 'EQ Forfour'],
      'Dacia': ['Sandero', 'Duster', 'Logan', 'Lodgy', 'Dokker', 'Spring'],
      'Chevrolet': ['Spark', 'Cruze', 'Malibu', 'Equinox', 'Tahoe', 'Silverado', 'Traverse', 'Blazer', 'Camaro', 'Corvette', 'Bolt'],
      'Chrysler': ['300', 'Pacifica', 'Voyager', 'Grand Caravan'],
      'Dodge': ['Charger', 'Challenger', 'Durango', 'Journey', 'Grand Caravan', 'Ram'],
      'Jeep': ['Renegade', 'Compass', 'Cherokee', 'Grand Cherokee', 'Wrangler', 'Gladiator', 'Wagoneer'],
      'Alfa Romeo': ['Giulia', 'Stelvio', '4C', 'Giulietta', 'Mito', '159', 'Brera'],
      'Aston Martin': ['DB11', 'Vantage', 'DBS', 'DBX', 'Rapide', 'Vanquish'],
      'Bentley': ['Continental', 'Flying Spur', 'Bentayga', 'Mulsanne'],
      'Ferrari': ['488', 'F8', 'Roma', 'Portofino', 'SF90', '812', 'GTC4Lusso', 'LaFerrari'],
      'Lamborghini': ['Huracan', 'Aventador', 'Urus', 'Gallardo'],
      'Maserati': ['Ghibli', 'Quattroporte', 'Levante', 'GranTurismo', 'MC20'],
      'McLaren': ['540C', '570S', '720S', 'GT', 'Artura', 'P1', '650S'],
      'Rolls-Royce': ['Ghost', 'Wraith', 'Dawn', 'Cullinan', 'Phantom'],
      'Infiniti': ['Q30', 'Q50', 'Q60', 'QX30', 'QX50', 'QX60', 'QX80', 'Q70']
    };

    // Function to update models based on selected make
    function updateCarModels() {
      const makeSelect = document.getElementById('car_make_select');
      const modelSelect = document.getElementById('car_model_select');
      
      if (!makeSelect || !modelSelect) {
        return;
      }
      
      const selectedMake = makeSelect.value;
      const previousMake = makeSelect.getAttribute('data-previous-make') || '';
      
      // Clear existing options
      modelSelect.innerHTML = '<option value="">All Models</option>';
      
      // If make changed, clear the model selection
      if (selectedMake !== previousMake) {
        modelSelect.value = '';
      }
      
      // Store current make for next comparison
      makeSelect.setAttribute('data-previous-make', selectedMake);
      
      if (selectedMake && carModels[selectedMake]) {
        // Add models for selected make
        carModels[selectedMake].forEach(function(model) {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
      // If no make selected, just show "All Models" (already set above)
    }

    // Initialize when DOM is ready
    function initCarModelFilter() {
      const makeSelect = document.getElementById('car_make_select');
      const modelSelect = document.getElementById('car_model_select');
      
      if (makeSelect && modelSelect) {
        // Store initial make value
        makeSelect.setAttribute('data-previous-make', makeSelect.value || '');
        
        // Initialize models based on current make selection
        updateCarModels();
        
        // Update models when make changes
        makeSelect.addEventListener('change', function() {
          updateCarModels();
        });
      }
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarModelFilter);
    } else {
      // DOM already loaded
      initCarModelFilter();
    }
  </script>
  <% end %>
  <% end %>

  <!-- Categories Section (only show on homepage, not on filtered listings page or browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="categories-section">
    <div class="container">
      <div class="categories-row">
        <% motors_category = Category.find_by("name ILIKE ?", "%motor%") || Category.find_by("name ILIKE ?", "%car%") %>
        <%= link_to motors_category ? "/listings?category_id=#{motors_category.id}" : listings_path(search: "Motors"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #3B82F6;">üöó</div>
          <span>Cars</span>
        <% end %>
        <%= link_to listings_path(search: "Property"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #22C55E;">üè†</div>
          <span>Properties</span>
        <% end %>
        <%= link_to listings_path(search: "Jobs"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #F97316;">üíº</div>
          <span>Jobs</span>
        <% end %>
        <%= link_to listings_path(search: "Services"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #EF4444;">üß≥</div>
          <span>Services</span>
        <% end %>
        <%= link_to listings_path(search: "Electronics"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #A855F7;">üîß</div>
          <span>Electronics</span>
        <% end %>
        <%= link_to listings_path(search: "Pets"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #3B82F6;">üêæ</div>
          <span>Pets</span>
        <% end %>
        <% furniture_category = Category.find_by("name ILIKE ?", "%furniture%") %>
        <%= link_to furniture_category ? "/listings?category_id=#{furniture_category.id}" : listings_path(search: "Furniture"), class: "category-icon-item", data: { turbo: false } do %>
          <div class="category-icon-large" style="color: #8B4513;">ü™ë</div>
          <span>Furniture</span>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Category Filter Section (show when browsing all ads via Browse button, not on homepage or when filters are applied) -->
  <% has_filters = params[:make].present? || params[:model].present? || params[:min_year].present? || params[:max_year].present? || params[:min_price].present? || params[:max_price].present? || params[:subcategory].present? %>
  <% if params[:category_id].blank? && params[:search].blank? && is_browse_page && !has_filters %>
  <section class="category-filter-section">
    <div class="container">
      <div class="category-filter-box">
        <h2 class="category-filter-title">Filter by Category</h2>
        <%= form_with url: listings_path, method: :get, local: true, class: "category-filter-form" do |f| %>
          <div class="category-filter-grid">
            <label class="category-filter-option <%= 'active' if params[:category_id].blank? %>">
              <%= f.radio_button :category_id, "", checked: params[:category_id].blank?, onchange: "this.form.submit();" %>
              <span class="category-filter-label">All Categories</span>
              <span class="category-count">(<%= Listing.count %>)</span>
            </label>
            <% @categories.each do |category| %>
              <label class="category-filter-option <%= 'active' if params[:category_id].to_i == category.id %>">
                <%= f.radio_button :category_id, category.id, checked: (params[:category_id].to_i == category.id), onchange: "this.form.submit();" %>
                <span class="category-filter-label"><%= category.name %></span>
                <span class="category-count">(<%= category.listings.count %>)</span>
              </label>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </section>
  <% end %>

  <!-- Filters Button (show when Motors category is selected) -->
  <% motors_category = Category.find_by("name ILIKE ?", "%motor%") || Category.find_by("name ILIKE ?", "%car%") %>
  <% if motors_category && (is_browse_page || @selected_category&.id == motors_category.id || params[:category_id].to_i == motors_category.id) && !has_filters %>
  <section class="filters-button-container">
    <div class="container">
      <button type="button" class="btn-show-filters" id="toggleFiltersBtn">Show Filters</button>
    </div>
  </section>
  
  <!-- Car Filter Section (hidden by default, shown when Filters button is clicked) -->
  <section class="car-filter-section" id="carFiltersSection">
    <div class="container">
      <div class="car-filter-box">
        <h2 class="car-filter-title">Filter Motors</h2>
        <%= form_with url: listings_path, method: :get, local: true, class: "car-filter-form" do |f| %>
          <%= f.hidden_field :category_id, value: motors_category.id %>
          <div class="car-filter-grid">
            <div class="car-filter-field">
              <%= f.label :subcategory, "Vehicle Type" %>
              <%= f.select :subcategory, options_for_select([
                ['All Types', ''],
                ['Car', 'Car'],
                ['Van', 'Van'],
                ['Truck', 'Truck'],
                ['Tractor', 'Tractor'],
                ['Motorcycle', 'Motorcycle'],
                ['Scooter', 'Scooter'],
                ['Quad', 'Quad'],
                ['Caravan', 'Caravan'],
                ['Trailer', 'Trailer'],
                ['Boat', 'Boat'],
                ['Other', 'Other']
              ], params[:subcategory]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :make, "All Makes" %>
              <%= f.select :make, options_for_select([
                ['All Makes', ''],
                ['Alfa Romeo', 'Alfa Romeo'],
                ['Aston Martin', 'Aston Martin'],
                ['Audi', 'Audi'],
                ['Bentley', 'Bentley'],
                ['BMW', 'BMW'],
                ['Chevrolet', 'Chevrolet'],
                ['Chrysler', 'Chrysler'],
                ['Citroen', 'Citroen'],
                ['Dacia', 'Dacia'],
                ['Dodge', 'Dodge'],
                ['Ferrari', 'Ferrari'],
                ['Fiat', 'Fiat'],
                ['Ford', 'Ford'],
                ['Honda', 'Honda'],
                ['Hyundai', 'Hyundai'],
                ['Infiniti', 'Infiniti'],
                ['Jaguar', 'Jaguar'],
                ['Jeep', 'Jeep'],
                ['Kia', 'Kia'],
                ['Lamborghini', 'Lamborghini'],
                ['Land Rover', 'Land Rover'],
                ['Lexus', 'Lexus'],
                ['Maserati', 'Maserati'],
                ['Mazda', 'Mazda'],
                ['McLaren', 'McLaren'],
                ['Mercedes-Benz', 'Mercedes-Benz'],
                ['Mini', 'Mini'],
                ['Mitsubishi', 'Mitsubishi'],
                ['Nissan', 'Nissan'],
                ['Opel', 'Opel'],
                ['Peugeot', 'Peugeot'],
                ['Porsche', 'Porsche'],
                ['Renault', 'Renault'],
                ['Rolls-Royce', 'Rolls-Royce'],
                ['Seat', 'Seat'],
                ['Skoda', 'Skoda'],
                ['Smart', 'Smart'],
                ['Subaru', 'Subaru'],
                ['Suzuki', 'Suzuki'],
                ['Tesla', 'Tesla'],
                ['Toyota', 'Toyota'],
                ['Vauxhall', 'Vauxhall'],
                ['Volkswagen', 'Volkswagen'],
                ['Volvo', 'Volvo']
              ], params[:make]), {}, { class: "car-filter-select", id: "car_make_select_buy" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :model, "All Models" %>
              <%= f.select :model, options_for_select([['All Models', '']], params[:model]), {}, { class: "car-filter-select", id: "car_model_select_buy" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_year, "Min Year" %>
              <%= f.select :min_year, options_for_select([['Min Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:min_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_year, "Max Year" %>
              <%= f.select :max_year, options_for_select([['Max Year', '']] + (1990..Date.current.year).to_a.reverse.map { |y| [y, y] }, params[:max_year]), {}, { class: "car-filter-select" } %>
            </div>
            <div class="car-filter-field">
              <%= f.label :min_price, "Min Price" %>
              <%= f.number_field :min_price, placeholder: "Min Price", class: "car-filter-input", min: 0, step: 100, value: params[:min_price] %>
            </div>
            <div class="car-filter-field">
              <%= f.label :max_price, "Max Price" %>
              <%= f.number_field :max_price, placeholder: "Max Price", class: "car-filter-input", min: 0, step: 100, value: params[:max_price] %>
            </div>
          </div>
          <div class="form-actions">
            <% motors_count = Listing.where(category_id: motors_category.id).count %>
            <%= f.submit "Search #{number_with_delimiter(motors_count)} Motors", class: "car-filter-button" %>
          </div>
        <% end %>
      </div>
    </div>
  </section>
  
  <script>
    // Car make-model relationships for Buy page
    const carModelsBuy = {
      'Audi': ['A1', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'Q2', 'Q3', 'Q5', 'Q7', 'Q8', 'TT', 'R8', 'e-tron', 'e-tron GT', 'RS3', 'RS4', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8'],
      'BMW': ['1 Series', '2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'Z4', 'i3', 'i4', 'iX', 'iX3', 'M2', 'M3', 'M4', 'M5', 'M8', 'X3 M', 'X4 M', 'X5 M', 'X6 M'],
      'Mercedes-Benz': ['A-Class', 'B-Class', 'C-Class', 'E-Class', 'S-Class', 'CLA', 'CLS', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'SL', 'AMG GT', 'EQC', 'EQS', 'EQE', 'C63 AMG', 'E63 AMG', 'S63 AMG', 'G63 AMG'],
      'Volkswagen': ['Golf', 'Polo', 'Passat', 'Jetta', 'Tiguan', 'Touareg', 'Arteon', 'T-Cross', 'T-Roc', 'ID.3', 'ID.4', 'ID.5', 'ID.Buzz', 'Beetle', 'Up!', 'Scirocco', 'Sharan', 'Touran', 'Amarok', 'Caddy'],
      'Ford': ['Fiesta', 'Focus', 'Mondeo', 'Kuga', 'Edge', 'Explorer', 'Mustang', 'Puma', 'EcoSport', 'Ranger', 'Transit', 'S-Max', 'Galaxy', 'Tourneo', 'Fusion', 'Escape', 'Expedition', 'F-150'],
      'Toyota': ['Aygo', 'Yaris', 'Corolla', 'Camry', 'Prius', 'C-HR', 'RAV4', 'Highlander', 'Land Cruiser', 'Hilux', 'Proace', 'Avensis', 'Auris', 'Verso', 'GT86', 'Supra', 'bZ4X'],
      'Honda': ['Civic', 'Accord', 'CR-V', 'HR-V', 'Pilot', 'Fit', 'Insight', 'Ridgeline', 'Passport', 'Odyssey', 'e', 'CR-Z', 'NSX'],
      'Hyundai': ['i10', 'i20', 'i30', 'Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Kona', 'Ioniq', 'Palisade', 'Venue', 'Nexo', 'IONIQ 5', 'IONIQ 6', 'Genesis', 'Veloster', 'Accent'],
      'Nissan': ['Micra', 'Sentra', 'Altima', 'Maxima', 'Juke', 'Qashqai', 'X-Trail', 'Pathfinder', 'Armada', 'Leaf', 'Ariya', '370Z', 'GT-R', 'Navara', 'Note', 'Pulsar'],
      'Renault': ['Clio', 'Megane', 'Scenic', 'Kadjar', 'Captur', 'Koleos', 'Talisman', 'Zoe', 'Twingo', 'Kangoo', 'Trafic', 'Master', 'Arkana', 'Austral'],
      'Peugeot': ['108', '208', '308', '508', '2008', '3008', '5008', 'Partner', 'Expert', 'Boxer', 'Rifter', 'Traveller', 'e-208', 'e-2008'],
      'Citroen': ['C1', 'C3', 'C4', 'C5', 'Berlingo', 'Cactus', 'C4 Picasso', 'Grand C4 Picasso', 'SpaceTourer', 'Jumper', 'e-C4', 'Ami'],
      'Skoda': ['Fabia', 'Octavia', 'Superb', 'Kodiaq', 'Karoq', 'Kamiq', 'Scala', 'Enyaq', 'Rapid', 'Yeti'],
      'Seat': ['Ibiza', 'Leon', 'Ateca', 'Tarraco', 'Arona', 'Formentor', 'Alhambra', 'Altea', 'Toledo', 'Cupra Born', 'Cupra Formentor'],
      'Mazda': ['Mazda2', 'Mazda3', 'Mazda6', 'CX-3', 'CX-5', 'CX-9', 'CX-30', 'MX-5', 'MX-30', 'BT-50'],
      'Kia': ['Picanto', 'Rio', 'Ceed', 'Optima', 'Sportage', 'Sorento', 'Stonic', 'Niro', 'EV6', 'Soul', 'Seltos', 'Telluride', 'Carnival', 'Stinger'],
      'Volvo': ['V40', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'S60', 'S90', 'C30', 'C70', 'XC70', 'EX30', 'EX90'],
      'Opel': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Vauxhall': ['Corsa', 'Astra', 'Insignia', 'Crossland', 'Grandland', 'Mokka', 'Adam', 'Karl', 'Combo', 'Vivaro', 'Movano', 'Corsa-e', 'Mokka-e'],
      'Fiat': ['500', 'Panda', 'Punto', 'Tipo', '500X', '500L', 'Doblo', 'Qubo', 'Talento', 'Ducato', '500e'],
      'Suzuki': ['Swift', 'Vitara', 'S-Cross', 'Jimny', 'Ignis', 'SX4', 'Baleno', 'Celerio', 'Across'],
      'Mitsubishi': ['Mirage', 'Lancer', 'Outlander', 'ASX', 'Eclipse Cross', 'Shogun', 'Pajero', 'i-MiEV'],
      'Subaru': ['Impreza', 'Legacy', 'Outback', 'Forester', 'XV', 'BRZ', 'Ascent', 'WRX', 'Levorg'],
      'Jaguar': ['XE', 'XF', 'XJ', 'F-Pace', 'E-Pace', 'I-Pace', 'F-Type', 'XK', 'X-Type'],
      'Land Rover': ['Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Sport', 'Range Rover Evoque', 'Defender', 'Range Rover Velar'],
      'Lexus': ['IS', 'ES', 'GS', 'LS', 'NX', 'RX', 'UX', 'GX', 'LX', 'LC', 'RC', 'CT'],
      'Porsche': ['911', '718', 'Panamera', 'Macan', 'Cayenne', 'Taycan', 'Boxster', 'Cayman'],
      'Tesla': ['Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster', 'Cybertruck'],
      'Mini': ['Hatch', 'Clubman', 'Countryman', 'Convertible', 'Paceman', 'Coupe', 'Roadster', 'One'],
      'Smart': ['Fortwo', 'Forfour', 'EQ Fortwo', 'EQ Forfour'],
      'Dacia': ['Sandero', 'Duster', 'Logan', 'Lodgy', 'Dokker', 'Spring'],
      'Chevrolet': ['Spark', 'Cruze', 'Malibu', 'Equinox', 'Tahoe', 'Silverado', 'Traverse', 'Blazer', 'Camaro', 'Corvette', 'Bolt'],
      'Chrysler': ['300', 'Pacifica', 'Voyager', 'Grand Caravan'],
      'Dodge': ['Charger', 'Challenger', 'Durango', 'Journey', 'Grand Caravan', 'Ram'],
      'Jeep': ['Renegade', 'Compass', 'Cherokee', 'Grand Cherokee', 'Wrangler', 'Gladiator', 'Wagoneer'],
      'Alfa Romeo': ['Giulia', 'Stelvio', '4C', 'Giulietta', 'Mito', '159', 'Brera'],
      'Aston Martin': ['DB11', 'Vantage', 'DBS', 'DBX', 'Rapide', 'Vanquish'],
      'Bentley': ['Continental', 'Flying Spur', 'Bentayga', 'Mulsanne'],
      'Ferrari': ['488', 'F8', 'Roma', 'Portofino', 'SF90', '812', 'GTC4Lusso', 'LaFerrari'],
      'Lamborghini': ['Huracan', 'Aventador', 'Urus', 'Gallardo'],
      'Maserati': ['Ghibli', 'Quattroporte', 'Levante', 'GranTurismo', 'MC20'],
      'McLaren': ['540C', '570S', '720S', 'GT', 'Artura', 'P1', '650S'],
      'Rolls-Royce': ['Ghost', 'Wraith', 'Dawn', 'Cullinan', 'Phantom'],
      'Infiniti': ['Q30', 'Q50', 'Q60', 'QX30', 'QX50', 'QX60', 'QX80', 'Q70']
    };

    function updateCarModelsBuy() {
      const makeSelect = document.getElementById('car_make_select_buy');
      const modelSelect = document.getElementById('car_model_select_buy');
      
      if (!makeSelect || !modelSelect) {
        return;
      }
      
      const selectedMake = makeSelect.value;
      const previousMake = makeSelect.getAttribute('data-previous-make') || '';
      
      modelSelect.innerHTML = '<option value="">All Models</option>';
      
      if (selectedMake !== previousMake) {
        modelSelect.value = '';
      }
      
      makeSelect.setAttribute('data-previous-make', selectedMake);
      
      if (selectedMake && carModelsBuy[selectedMake]) {
        carModelsBuy[selectedMake].forEach(function(model) {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
      // If no make selected, just show "All Models" (already set above)
    }

    function initCarModelFilterBuy() {
      const makeSelect = document.getElementById('car_make_select_buy');
      const modelSelect = document.getElementById('car_model_select_buy');
      
      if (makeSelect && modelSelect) {
        makeSelect.setAttribute('data-previous-make', makeSelect.value || '');
        updateCarModelsBuy();
        makeSelect.addEventListener('change', function() {
          updateCarModelsBuy();
        });
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarModelFilterBuy);
    } else {
      initCarModelFilterBuy();
    }
  </script>
  <% end %>


  <!-- Featured Listings Section -->
  <section class="listings-section">
    <div class="container">
      <div class="homepage-main-content">
        <div class="featured-listings-column">
          <div class="section-header">
            <% if has_filters && params[:subcategory] == "Car" %>
              <h2 class="section-title">Car Search Results</h2>
            <% elsif @selected_category %>
              <h2 class="section-title"><%= @selected_category.name %> Listings</h2>
            <% elsif params[:category_id].present? || params[:search].present? %>
              <h2 class="section-title">Search Results</h2>
            <% elsif is_browse_page %>
              <h2 class="section-title">All Listings</h2>
            <% else %>
              <h2 class="section-title">Featured Listings</h2>
            <% end %>
            <% unless is_browse_page || has_filters %>
              <%= link_to "View All >", listings_path, class: "view-all-link" %>
            <% end %>
          </div>

          <% if is_browse_page %>
            <div class="mobile-filters-bar">
              <%= form_with url: listings_path, method: :get, local: true, class: "mobile-filters-form" do |f| %>
                <div class="mobile-filters-row">
                  <%= f.select :category_id,
                               options_from_collection_for_select(@categories, :id, :name, params[:category_id]),
                               { include_blank: "All categories" },
                               class: "mobile-filter-select" %>
                  <%= f.text_field :location,
                                   placeholder: "Location",
                                   value: params[:location],
                                   class: "mobile-filter-input" %>
                </div>
                <div class="mobile-filters-row">
                  <%= f.text_field :search,
                                   placeholder: "What are you looking for?",
                                   value: params[:search],
                                   class: "mobile-filter-input" %>
                  <%= f.submit "Filter", class: "mobile-filter-button" %>
                </div>
              <% end %>
            </div>
          <% end %>
      
      <% if @listings.any? %>
        <% if @selected_category || params[:category_id].present? || params[:search].present? || has_filters %>
          <p class="filter-info" style="margin-bottom: 1.5rem; color: #666; font-size: 0.9375rem;">
            Showing <%= @listings.count %> <%= @listings.count == 1 ? 'listing' : 'listings' %>
            <% if has_filters && params[:subcategory] == "Car" %>
              <% filter_parts = [] %>
              <% filter_parts << params[:make] if params[:make].present? %>
              <% filter_parts << params[:model] if params[:model].present? %>
              <% if filter_parts.any? %>
                matching <%= filter_parts.join(' ') %>
              <% else %>
                matching your search criteria
              <% end %>
            <% elsif @selected_category %>
              in <%= @selected_category.name %>
            <% end %>
          </p>
        <% end %>
        <% listings_to_show = if @selected_category || params[:category_id].present? || params[:search].present? || has_filters || is_browse_page
                                 @listings
                               else
                                 (@featured_listings || @listings.order(Arel.sql('RANDOM()')).limit(4))
                               end %>
        <% is_homepage_grid = !is_browse_page && !params[:category_id].present? && !params[:search].present? && !has_filters %>
        <div class="listings-grid <%= 'homepage-grid' if is_homepage_grid %>">
          <% listings_to_show.each do |listing| %>
            <div class="listing-card">
              <%= link_to listing, class: "listing-card-link" do %>
                <div class="listing-image">
                  <% if listing.images.attached? %>
                    <%= image_tag listing.ordered_images.first, class: "listing-card-image" %>
                  <% else %>
                    <div class="image-placeholder">
                      <span>üì∑</span>
                    </div>
                  <% end %>
                </div>
                <div class="listing-content">
                  <h3 class="listing-title">
                    <%= listing.title %>
                  </h3>
                  <div class="listing-details">
                    <p class="listing-location">üìç <%= listing.city || "Location not specified" %></p>
                    <% if listing.extra_fields&.dig('year') || listing.extra_fields&.dig('mileage') || listing.extra_fields&.dig('engine_size') || listing.extra_fields&.dig('fuel_type') %>
                      <p class="listing-specs">
                        <% if listing.extra_fields&.dig('year') %>
                          <span><%= listing.extra_fields['year'] %></span>
                        <% end %>
                        <% if listing.extra_fields&.dig('mileage') %>
                          <span><%= number_with_delimiter(listing.extra_fields['mileage'].to_i) %> km</span>
                        <% end %>
                        <% if listing.extra_fields&.dig('engine_size') %>
                          <span><%= listing.extra_fields['engine_size'].to_s.gsub(/\s*L\s*/i, '').gsub(/\s*Litre\s*/i, '').gsub(/\s*Liter\s*/i, '') %>L</span>
                        <% end %>
                        <% if listing.extra_fields&.dig('fuel_type') %>
                          <span><%= listing.extra_fields['fuel_type'] %></span>
                        <% end %>
                      </p>
                    <% end %>
                  </div>
                  <div class="listing-footer">
                    <span class="listing-price">
                      <% if listing.price %>
                        ‚Ç¨<%= number_with_delimiter(listing.price.to_i) %>
                      <% else %>
                        Price on request
                      <% end %>
                    </span>
                    <span class="btn-view">View</span>
                  </div>
                </div>
              <% end %>
              <% if user_signed_in? %>
                <% is_favorited = current_user.favorites.exists?(listing_id: listing.id) %>
                <% favorite = current_user.favorites.find_by(listing_id: listing.id) if is_favorited %>
                <div class="favorite-heart-container" data-listing-id="<%= listing.id %>" data-favorite-id="<%= favorite&.id %>">
                  <button class="favorite-heart-btn <%= 'favorite-heart-active' if is_favorited %>" 
                          data-listing-id="<%= listing.id %>"
                          data-favorited="<%= is_favorited %>"
                          title="<%= is_favorited ? 'Remove from favorites' : 'Add to favorites' %>">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="<%= is_favorited ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                  </button>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <p class="empty-message">No listings yet. Be the first to <%= link_to "post an ad", new_listing_path, class: "link" %>!</p>
        </div>
      <% end %>
        </div>
        
        <!-- Sell Your Stuff Today Box (only show on homepage, not on browse page) -->
        <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
        <div class="sell-box-column">
          <div class="sell-box">
            <h2 class="sell-box-title">Sell Your Stuff Today</h2>
            <p class="sell-box-text">Post your ad in minutes and reach thousands of buyers in your area.</p>
            <%= link_to "Place an Ad", new_listing_path, class: "btn-place-ad" %>
            <div class="sell-box-benefits">
              <div class="benefit-item">
                <span class="check-icon">‚úì</span>
                <span>Free and easy to use</span>
              </div>
              <div class="benefit-item">
                <span class="check-icon">‚úì</span>
                <span>Reach local buyers</span>
              </div>
              <div class="benefit-item">
                <span class="check-icon">‚úì</span>
                <span>Safe and secure</span>
              </div>
            </div>
          </div>
        </div>
        <% end %>
      </div>
    </div>
  </section>

  <!-- CTA Section (only show on homepage, not on browse page) -->
  <% unless params[:category_id].present? || params[:search].present? || is_browse_page %>
  <section class="cta-section">
    <div class="container">
      <h2>Ready to sell something?</h2>
      <p>Post your ad for free - it only takes a minute!</p>
      <%= link_to "Post Your Ad Now", new_listing_path, class: "btn-cta" %>
    </div>
  </section>
  <% end %>
</div>

<script>
  // Toggle car filters visibility
  function initFiltersToggle() {
    const toggleBtn = document.getElementById('toggleFiltersBtn');
    const filtersSection = document.getElementById('carFiltersSection');
    
    if (!toggleBtn || !filtersSection) return;
    
    // Guard: avoid duplicate listeners
    if (toggleBtn.hasAttribute('data-filters-initialized')) return;
    toggleBtn.setAttribute('data-filters-initialized', 'true');
    
    toggleBtn.addEventListener('click', function() {
      const isVisible = filtersSection.classList.contains('show');
      
      if (isVisible) {
        filtersSection.classList.remove('show');
        toggleBtn.textContent = 'Show Filters';
        toggleBtn.classList.remove('hide');
      } else {
        filtersSection.classList.add('show');
        toggleBtn.textContent = 'Hide Filters';
        toggleBtn.classList.add('hide');
      }
    });
  }
  
  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFiltersToggle);
  } else {
    initFiltersToggle();
  }
  
  // Re-initialize on Turbo navigation
  document.addEventListener('turbo:load', initFiltersToggle);
  document.addEventListener('turbo:render', initFiltersToggle);
</script>
