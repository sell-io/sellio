<% content_for :title, @listing.title %>

<% if notice %>
  <div class="alert alert-success"><%= notice %></div>
<% end %>

<% breadcrumb_items = [[ "Home", root_path ]] %>
<% if @listing.category %>
  <% breadcrumb_items << [ @listing.category.name, listings_path(category_id: @listing.category.id) ] %>
<% end %>
<% subcat = @listing.extra_fields&.dig("subcategory") %>
<% if subcat.present? %>
  <% breadcrumb_items << [ subcat, listings_path(category_id: @listing.category_id, subcategory: subcat) ] %>
<% end %>
<% breadcrumb_items << [ @listing.title, nil ] %>
<%= render "shared/breadcrumbs", items: breadcrumb_items %>

<div class="listing-detail">
  <div class="listing-detail-container">
    <!-- Main Content: Images + Details on Left, Seller Info on Right -->
    <div class="listing-main-content">
      <!-- Images and Details on the Left -->
      <div class="listing-images-section">
        <% ordered_images = @listing.ordered_images.to_a %>
        <% Rails.logger.info "Listing #{@listing.id} - ordered_images count: #{ordered_images.count}, image_order: #{@listing.extra_fields&.dig('image_order').inspect}, total attachments: #{@listing.images_attachments.count}" %>
        <% if ordered_images.any? %>
          <div class="image-gallery-container">
            <!-- Small thumbnails on the left side -->
            <div class="thumbnail-images-sidebar">
              <% max_thumbnails = 5 %>
              <% ordered_images.first(max_thumbnails).each_with_index do |image, index| %>
                <%= image_tag image, class: "thumbnail-image #{'thumbnail-active' if index == 0}", 
                              data: { image_index: index, image_url: url_for(image) } %>
              <% end %>
              <% if ordered_images.count > max_thumbnails %>
                <div class="view-all-photos-thumbnail" id="view-all-photos-btn">
                  <div class="view-all-overlay">
                    <span class="view-all-text">+<%= ordered_images.count - max_thumbnails %></span>
                    <span class="view-all-label">View all</span>
                  </div>
                </div>
              <% end %>
            </div>
            <div class="main-image" id="main-image-container">
              <%= image_tag ordered_images.first, class: "listing-main-image", id: "main-listing-image", data: { image_url: url_for(ordered_images.first) } %>
            </div>
            
            <!-- Hidden images for JavaScript to access all images -->
            <div style="display: none;" id="all-images-data">
              <% ordered_images.each_with_index do |image, index| %>
                <% if image.present? %>
                  <%= image_tag image, class: "hidden-gallery-image", 
                                data: { image_index: index, image_url: url_for(image) } %>
                <% end %>
              <% end %>
            </div>
          </div>
          
          <!-- Title, Price, and Description below images -->
          <div class="listing-details-below-images">
            <!-- Title -->
            <div class="listing-header">
              <h1 class="listing-detail-title"><%= @listing.title %></h1>
              <div class="listing-meta">
                <% if @listing.sold? %>
                  <span class="listing-badge-sold">Sold</span>
                <% end %>
                <% if @listing.boosted? %>
                  <span class="listing-badge-boosted"><%= @listing.boost_time_left ? "Boosted (#{@listing.boost_time_left})" : "Boosted" %></span>
                <% end %>
                <% subcategory = @listing.extra_fields&.dig('subcategory') %>
                <% if subcategory.present? %>
                  <span class="subcategory-badge"><%= subcategory %></span>
                <% elsif @listing.category %>
                  <span class="category-badge"><%= @listing.category.name %></span>
                <% end %>
                <span class="listing-date">Posted <%= time_ago_in_words(@listing.created_at) %> ago</span>
              </div>
            </div>

            <div class="listing-price-section">
              <span class="listing-price-large">
                <% if @listing.price %>
                  ‚Ç¨<%= number_with_delimiter(@listing.price.to_i) %>
                <% else %>
                  Price on request
                <% end %>
              </span>
            </div>
            
            <!-- Location and Seller Info -->
            <div class="listing-info">
              <div class="info-item">
                <strong>üìç Location:</strong>
                <span><%= @listing.city || "Not specified" %></span>
              </div>
              <% if @listing.user %>
                <div class="info-item">
                  <strong>üë§ Seller:</strong>
                  <span><%= link_to (@listing.user.name || @listing.user.email), user_path(@listing.user), class: "seller-link #{'verified-seller-link' if @listing.user.is_verified}" %><% if @listing.user.is_verified %> <span class="verified-badge-inline" title="Verified Seller">‚úì</span><% end %></span>
                </div>
              <% end %>
            </div>

            <!-- Category-Specific Details (Motors) -->
            <% if @listing.category&.name == "Motors" && @listing.extra_fields.present? %>
              <div class="category-details">
                <h2>Vehicle Details</h2>
                <div class="details-grid">
                  <% if @listing.make.present? || @listing.model.present? %>
                    <div class="detail-item">
                      <strong>Make & Model:</strong>
                      <span><%= [@listing.make, @listing.model].compact.join(' ') %></span>
                    </div>
                  <% end %>
                  <% if @listing.year.present? %>
                    <div class="detail-item">
                      <strong>Year:</strong>
                      <span><%= @listing.year %></span>
                    </div>
                  <% end %>
                  <% if @listing.mileage.present? %>
                    <div class="detail-item">
                      <strong>Mileage:</strong>
                      <span><%= number_with_delimiter(@listing.mileage) %> km</span>
                    </div>
                  <% end %>
                  <% if @listing.engine_size.present? %>
                    <div class="detail-item">
                      <strong>Engine Size:</strong>
                      <span><%= @listing.engine_size %></span>
                    </div>
                  <% end %>
                  <% if @listing.fuel_type.present? %>
                    <div class="detail-item">
                      <strong>Fuel Type:</strong>
                      <span><%= @listing.fuel_type %></span>
                    </div>
                  <% end %>
                  <% if @listing.transmission.present? %>
                    <div class="detail-item">
                      <strong>Transmission:</strong>
                      <span><%= @listing.transmission %></span>
                    </div>
                  <% end %>
                  <% if @listing.previous_owners.present? %>
                    <div class="detail-item">
                      <strong>Previous Owners:</strong>
                      <span><%= @listing.previous_owners %></span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
            
                <!-- Description -->
                <% if @listing.description.present? %>
                  <div class="listing-description-section">
                    <h2>Description</h2>
                    <div class="listing-description-wrap collapsed" id="listing-description-wrap">
                      <div class="listing-description">
                        <%= simple_format(@listing.description) %>
                      </div>
                    </div>
                    <button type="button" class="btn-read-all" id="btn-read-all" aria-expanded="false">Read all</button>
                  </div>
                <% end %>
              </div>
              
              <!-- Back to Listings Button -->
              <div class="listing-actions">
                <% if user_signed_in? && current_user != @listing.user %>
                  <% is_favorited = current_user.favorites.exists?(listing_id: @listing.id) %>
                  <% favorite = current_user.favorites.find_by(listing_id: @listing.id) if is_favorited %>
                  <button class="btn-favorite <%= 'btn-favorite-active' if is_favorited %>" 
                          data-listing-id="<%= @listing.id %>"
                          data-favorited="<%= is_favorited %>"
                          data-favorite-id="<%= favorite&.id %>">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="<%= is_favorited ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <%= is_favorited ? 'Saved' : 'Save Ad' %>
                  </button>
                <% end %>
                <button type="button" class="btn-share-listing" id="share-listing-btn" data-url="<%= listing_url(@listing) %>" data-title="<%= @listing.title %>">Share</button>
                <% if user_signed_in? && current_user != @listing.user %>
                  <%= link_to "Report Ad", new_report_path(listing_id: @listing.id), class: "btn-report-listing" %>
                <% end %>
                <%= link_to "Back to Listings", listings_path, class: "btn-back" %>
              </div>
            <% else %>
              <div class="image-placeholder-large">
                <span>üì∑</span>
                <p>No images available</p>
              </div>
              <!-- Back to Listings Button for no images case -->
              <div class="listing-actions">
                <%= link_to "Back to Listings", listings_path, class: "btn-back" %>
              </div>
            <% end %>
      </div>
      
      <!-- Seller Info Card on the Right -->
      <% if @listing.user %>
        <div class="seller-info-card">
          <div class="seller-info-header">
            <div class="seller-avatar">
              <% if @listing.user.avatar.attached? %>
                <%= image_tag @listing.user.avatar, class: "seller-avatar-image" %>
              <% else %>
                <div class="seller-avatar-placeholder">
                  <%= (@listing.user.name || @listing.user.email).first.upcase %>
                </div>
              <% end %>
            </div>
            <div class="seller-info-text">
              <div class="seller-name-row">
                <h3 class="seller-name <%= 'verified-seller-name' if @listing.user.is_verified %>"><%= @listing.user.name || @listing.user.email %></h3>
                <% if @listing.user.is_verified %>
                  <span class="seller-badge-verified" title="Verified Seller (paid)">‚úì Verified seller</span>
                <% elsif @listing.user.email.present? || @listing.user.phone.present? %>
                  <span class="seller-badge-contact" title="Contact details on profile">Contact details added</span>
                <% end %>
              </div>
              <p class="seller-type-location">
                <span>Private Seller</span>
                <% if @listing.city.present? %>
                  <span class="separator">‚Ä¢</span>
                  <span><%= @listing.city %></span>
                <% end %>
              </p>
              <% if @listing.user.created_at.present? %>
                <p class="seller-meta">Member since <%= @listing.user.created_at.strftime("%b %Y") %></p>
              <% end %>
            </div>
          </div>
          
          <div class="seller-stats">
            <div class="seller-stat-item">
              <div class="stat-icon">‚òÖ</div>
              <div class="stat-content">
                <div class="stat-value">No rating</div>
              </div>
            </div>
            <div class="seller-stat-item">
              <div class="stat-content">
                <div class="stat-value">0</div>
                <div class="stat-label">No reviews yet</div>
              </div>
            </div>
            <div class="seller-stat-item">
              <div class="stat-content">
                <div class="stat-value"><%= time_ago_in_words(@listing.user.created_at) %></div>
                <div class="stat-label">on Dealo</div>
              </div>
            </div>
          </div>
          
          <div class="seller-actions">
            <% if user_signed_in? %>
              <% if current_user == @listing.user || current_user&.admin? %>
                <% if @listing.sold? %>
                  <%= button_to "Mark as available", mark_available_listing_path(@listing), method: :post, class: "btn-seller-action btn-available" %>
                <% else %>
                  <%= button_to "Mark as sold", mark_as_sold_listing_path(@listing), method: :post, class: "btn-seller-action btn-sold", form: { data: { turbo_confirm: "Mark this listing as sold?" } } %>
                <% end %>
                <% unless @listing.boosted? %>
                  <% if current_user.is_verified? && current_user.free_boosts_remaining > 0 %>
                    <%= link_to "Use free boost (#{current_user.free_boosts_remaining} left this month)", boost_listing_path(@listing.id), class: "btn-seller-action btn-boost", data: { turbo: "false" } %>
                  <% else %>
                    <%= link_to "Boost listing (‚Ç¨1, 7 days)", boost_listing_path(@listing.id), class: "btn-seller-action btn-boost", data: { turbo: "false" } %>
                  <% end %>
                <% end %>
                <%= link_to "Edit Listing", edit_listing_path(@listing), class: "btn-seller-action btn-edit" %>
                <%= button_to "Delete Listing", @listing, method: :delete,
                              data: { turbo_confirm: "Are you sure you want to delete this listing?" },
                              class: "btn-seller-action btn-delete" %>
              <% end %>
              <% if current_user != @listing.user && @listing.user %>
                <%= link_to "Send Message", new_message_path(listing_id: @listing.id, recipient_id: @listing.user.id), class: "btn-seller-primary" %>
              <% end %>
            <% else %>
              <%= link_to "Login to Contact Seller", new_user_session_path, class: "btn-seller-primary" %>
            <% end %>
          </div>
          
          <!-- Phone Number Displayed Directly -->
          <% if @listing.user.phone.present? %>
            <div class="seller-phone-display">
              <strong>Phone:</strong>
              <%= link_to @listing.user.phone, "tel:#{@listing.user.phone.gsub(/\s+/, '')}", class: "phone-number-link", title: "Tap or click to call" %>
              <span class="phone-call-hint">Tap to call</span>
            </div>
          <% end %>
          
          <!-- View all ads link -->
          <div class="seller-view-ads">
            <%= link_to "View all ads", user_path(@listing.user), class: "view-ads-link" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Similar Listings -->
    <% if @similar_listings.present? %>
      <section class="similar-listings-section">
        <h2 class="similar-listings-title">Similar listings</h2>
        <div class="similar-listings-grid">
          <% @similar_listings.each do |listing| %>
            <div class="similar-listing-card">
              <%= link_to listing, class: "similar-listing-link" do %>
                <div class="similar-listing-image">
                  <% if listing.images.attached? %>
                    <%= image_tag listing.ordered_images.first, class: "similar-listing-img", alt: listing.title %>
                  <% else %>
                    <div class="image-placeholder small">üì∑</div>
                  <% end %>
                  <% if listing.sold? %>
                    <span class="listing-badge-sold-overlay">Sold</span>
                  <% end %>
                </div>
                <div class="similar-listing-content">
                  <h3 class="similar-listing-title"><%= listing.title.truncate(50) %></h3>
                  <span class="similar-listing-price">
                    <% if listing.price %>
                      ‚Ç¨<%= number_with_delimiter(listing.price.to_i) %>
                    <% else %>
                      Price on request
                    <% end %>
                  </span>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </section>
    <% end %>

    <!-- Image Modal/Lightbox -->
    <div class="image-modal" id="image-modal" style="display: none;">
      <span class="image-modal-close" id="modal-close">&times;</span>
      <img class="image-modal-content" id="modal-image">
      <% ordered_images = @listing.ordered_images %>
      <% if ordered_images.any? && ordered_images.count > 1 %>
        <button class="image-modal-nav image-modal-prev" id="modal-prev-btn">‚Äπ</button>
        <button class="image-modal-nav image-modal-next" id="modal-next-btn">‚Ä∫</button>
      <% end %>
    </div>

  </div>
</div>

<script>
  // Image gallery functionality with swipe and modal
  // Use both DOMContentLoaded and turbo:load for compatibility
  (function() {
    let galleryInitialized = false;
    let currentImageIndex = 0;
    let imageUrls = [];
    let thumbnailImages = [];
    let mainImage = null;
    let mainImageContainer = null;
    let modal = null;
    let modalImage = null;
    
    function initImageGallery() {
      // Get elements fresh each time
      thumbnailImages = Array.from(document.querySelectorAll('.thumbnail-image'));
      mainImage = document.getElementById('main-listing-image');
      mainImageContainer = document.getElementById('main-image-container');
      modal = document.getElementById('image-modal');
      modalImage = document.getElementById('modal-image');
      const modalClose = document.getElementById('modal-close');
      const modalPrevBtn = document.getElementById('modal-prev-btn');
      const modalNextBtn = document.getElementById('modal-next-btn');
      const viewAllPhotosBtn = document.getElementById('view-all-photos-btn');
      
      if (!mainImage) {
        galleryInitialized = false;
        return;
      }
      
      // Reset state
      currentImageIndex = 0;
      imageUrls = [];
    
      // Store ALL image URLs from hidden images container
      const allImagesContainer = document.getElementById('all-images-data');
      if (allImagesContainer) {
        const allHiddenImages = Array.from(allImagesContainer.querySelectorAll('.hidden-gallery-image'));
        allHiddenImages.forEach(function(img) {
          const fullSizeUrl = img.getAttribute('data-image-url') || img.src;
          if (fullSizeUrl) {
            imageUrls.push(fullSizeUrl);
          }
        });
      }
      
      // Fallback: if no hidden images, get from visible thumbnails and main image
      if (imageUrls.length === 0) {
        if (thumbnailImages.length > 0) {
          thumbnailImages.forEach(function(thumbnail) {
            const fullSizeUrl = thumbnail.getAttribute('data-image-url') || thumbnail.src;
            if (fullSizeUrl) {
              imageUrls.push(fullSizeUrl);
            }
          });
        }
        if (mainImage.src) {
          const mainImageUrl = mainImage.getAttribute('data-image-url') || mainImage.src;
          if (mainImageUrl && !imageUrls.includes(mainImageUrl)) {
            imageUrls.unshift(mainImageUrl);
          }
        }
      }
      
      // Handle "View all photos" button click
      if (viewAllPhotosBtn) {
        viewAllPhotosBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          // Open modal at first image
          openModal(0);
        });
      }
      
      // Reset to first image
      currentImageIndex = 0;
    
      // Function to update main image
      function updateMainImage(index) {
        if (imageUrls.length === 0) return;
        if (index < 0) index = imageUrls.length - 1;
        if (index >= imageUrls.length) index = 0;
        
        currentImageIndex = index;
        currentImageIndex = index;
        
        // Use full-size URL for main image
        const fullSizeUrl = thumbnailImages[index]?.getAttribute('data-image-url') || imageUrls[index];
        if (mainImage && fullSizeUrl) {
          mainImage.src = fullSizeUrl;
          // Also update data attribute
          mainImage.setAttribute('data-image-url', fullSizeUrl);
        }
        
        // Update thumbnail active state
        thumbnailImages.forEach(function(img, idx) {
          img.classList.toggle('thumbnail-active', idx === index);
        });
      }
      
      // Remove old event listeners by cloning elements (clean slate)
      // Thumbnail click handlers
      thumbnailImages.forEach(function(thumbnail, index) {
        // Remove old listener by cloning
        const newThumbnail = thumbnail.cloneNode(true);
        thumbnail.parentNode.replaceChild(newThumbnail, thumbnail);
        thumbnailImages[index] = newThumbnail;
        
        newThumbnail.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          updateMainImage(index);
        });
      });
      
      // Previous/Next button handlers removed - using thumbnails only
      
      // Click main image to open modal
      if (mainImageContainer) {
        mainImageContainer.addEventListener('click', function(e) {
          // Don't open modal if clicking navigation buttons
          if (e.target.classList.contains('image-nav-btn')) return;
          if (e.target.closest('.image-nav-btn')) return;
          openModal(currentImageIndex);
        });
      }
    
      // Open modal
      function openModal(index) {
        if (modal && modalImage && imageUrls.length > 0) {
          if (index < 0) index = imageUrls.length - 1;
          if (index >= imageUrls.length) index = 0;
          // Use full-size URL for modal
          const fullSizeUrl = thumbnailImages[index]?.getAttribute('data-image-url') || imageUrls[index];
          if (fullSizeUrl) {
            modalImage.src = fullSizeUrl;
            currentImageIndex = index;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
          }
        }
      }
      
      // Close modal
      function closeModal() {
        if (modal) {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      }
      
      if (modalClose) {
        modalClose.addEventListener('click', closeModal);
      }
      
      // Modal navigation
      if (modalPrevBtn) {
        modalPrevBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
            const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
            if (modalImage && fullSizeUrl) {
              modalImage.src = fullSizeUrl;
            }
          }
        });
      }
      
      if (modalNextBtn) {
        modalNextBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
            if (modalImage && fullSizeUrl) {
              modalImage.src = fullSizeUrl;
            }
          }
        });
      }
      
      // Close modal on background click
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal || e.target === modalImage) {
            closeModal();
          }
        });
      }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (modal && modal.style.display === 'block') {
        if (e.key === 'Escape') {
          closeModal();
        } else if (e.key === 'ArrowLeft') {
          currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
          const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
          modalImage.src = fullSizeUrl;
        } else if (e.key === 'ArrowRight') {
          currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
          const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
          modalImage.src = fullSizeUrl;
        }
      }
    });
    
      // Swipe functionality for touch devices
      let touchStartX = 0;
      let touchEndX = 0;
      
      if (mainImageContainer) {
        mainImageContainer.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        mainImageContainer.addEventListener('touchend', function(e) {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        }, { passive: true });
      }
      
      if (modal) {
        modal.addEventListener('touchstart', function(e) {
          touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        modal.addEventListener('touchend', function(e) {
          touchEndX = e.changedTouches[0].screenX;
          if (modal.style.display === 'block') {
            handleModalSwipe();
          }
        }, { passive: true });
      }
      
      function handleSwipe() {
        if (imageUrls.length === 0) return;
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            // Swipe left - next image
            updateMainImage(currentImageIndex + 1);
          } else {
            // Swipe right - previous image
            updateMainImage(currentImageIndex - 1);
          }
        }
      }
      
      function handleModalSwipe() {
        if (imageUrls.length === 0) return;
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            // Swipe left - next image
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
            if (modalImage && fullSizeUrl) {
              modalImage.src = fullSizeUrl;
            }
          } else {
            // Swipe right - previous image
            currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
            const fullSizeUrl = thumbnailImages[currentImageIndex]?.getAttribute('data-image-url') || imageUrls[currentImageIndex];
            if (modalImage && fullSizeUrl) {
              modalImage.src = fullSizeUrl;
            }
          }
        }
      }
      
      // Mark as initialized
      galleryInitialized = true;
    }
    
    // Initialize on page load
    function initializeOnTurbo() {
      galleryInitialized = false;
      initImageGallery();
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeOnTurbo);
    } else {
      initializeOnTurbo();
    }
    
    // Re-initialize on Turbo navigation
    document.addEventListener('turbo:load', initializeOnTurbo);
    document.addEventListener('turbo:render', initializeOnTurbo);
  })();

  // Share listing: Web Share API with copy-link fallback
  (function() {
    const shareBtn = document.getElementById('share-listing-btn');
    if (!shareBtn) return;
    shareBtn.addEventListener('click', function() {
      const url = shareBtn.getAttribute('data-url') || window.location.href;
      const title = shareBtn.getAttribute('data-title') || document.title;
      if (navigator.share) {
        navigator.share({ title: title, url: url }).then(function() {
          shareBtn.textContent = 'Shared!';
          setTimeout(function() { shareBtn.textContent = 'Share'; }, 2000);
        }).catch(function() {});
      } else {
        navigator.clipboard.writeText(url).then(function() {
          shareBtn.textContent = 'Link copied!';
          setTimeout(function() { shareBtn.textContent = 'Share'; }, 2000);
        }).catch(function() {
          shareBtn.textContent = 'Copy link';
        });
      }
    });
  })();

  // Description "Read all" / "Show less" toggle
  (function() {
    var wrap = document.getElementById('listing-description-wrap');
    var btn = document.getElementById('btn-read-all');
    if (!wrap || !btn) return;
    btn.addEventListener('click', function() {
      var isExpanded = wrap.classList.contains('expanded');
      if (isExpanded) {
        wrap.classList.remove('expanded');
        wrap.classList.add('collapsed');
        btn.textContent = 'Read all';
        btn.setAttribute('aria-expanded', 'false');
      } else {
        wrap.classList.remove('collapsed');
        wrap.classList.add('expanded');
        btn.textContent = 'Show less';
        btn.setAttribute('aria-expanded', 'true');
      }
    });
  })();
</script>
